var middleClicked=!1;document.addEventListener("mousedown",function(e){1===e.button&&(middleClicked=!0)});const urlParams=new URLSearchParams(window.location.search),NO_SECRET_MODE=urlParams.has("nosecret"),NO_FOOLS_MODE=urlParams.has("nofools"),UNLOCK_MODE=urlParams.has("unlock"),SCALE=urlParams.get("scale")??1,DPR=urlParams.get("dpr")??devicePixelRatio;print("DPR:",DPR),NO_SECRET_MODE&&localStorage.setItem("secretHasAlreadyBeenRevealed","true");const secretHasAlreadyBeenRevealed=localStorage.getItem("secretHasAlreadyBeenRevealed"),TODEPOND_COLOURS=[Colour.Green.splash,Colour.Red.splash,Colour.Blue.splash,Colour.Yellow.splash,Colour.Orange.splash,Colour.Pink.splash,Colour.Rose.splash,Colour.Cyan.splash,Colour.Purple.splash,Colour.Black.splash,Colour.Grey.splash,Colour.Silver.splash,Colour.White.splash,],TODEPOND_RAINBOW_COLOURS=TODEPOND_COLOURS.slice(0,-4),getRGB=e=>{let t=e%100,l=t%10,i=t-l;return[e-t,i,l]},clamp=(e,t,l)=>e<t?t:e>l?l:e,wrap=(e,t,l)=>{let i=l-t+1;return e<t?wrap(e+i,t,l):e>l?wrap(e-i,t,l):e};let brushColourCycleIndex=0;const brushColourCycle=[999,Colour.Green.splash,Colour.Blue.splash,Colour.Red.splash,Colour.Yellow.splash,Colour.Black.splash,Colour.Rose.splash,Colour.Cyan.splash,Colour.Orange.splash,Colour.Purple.splash,Colour.Pink.splash,Colour.Grey.splash,Colour.Silver.splash,],makeCell=({x:e=0,y:t=0,width:l=1,height:i=1,colour:o=112}={})=>{let a=e,r=e+l,n=t,d=t+i,h=l*i,s=a+l/2,c=n+i/2,u=[],g=void 0,$={x:e,y:t,width:l,height:i,colour:o,left:a,right:r,top:n,bottom:d,centerX:s,centerY:c,sections:u,size:h,lastDraw:g,lastDrawRepeat:0};return $};let edgeMode=0;const pickCell=(e,t)=>{if(e>=1||t>=1||e<0||t<0)return;let l=Math.floor(e*GRID_SIZE),i=Math.floor(t*GRID_SIZE),o=l*GRID_SIZE+i,a=state.grid[o];if(void 0===a)return;let r=1,n=a.size,d=a.values();for(let h of d)if(r===n||(r++,!(h.left>e)&&!(h.top>t)&&!(h.right<=e)&&!(h.bottom<=t)))return h},pickNeighbour=(e,t,l)=>{let i=e.left+e.width/2,o=e.top+e.height/2,a=i+t*e.width,r=o+l*e.height,n=pickCell(a,r);return n},pickRandomCell=()=>{let e=Random.Uint32/4294967295,t=Random.Uint32/4294967295,l=pickCell(e,t);return l},pickRandomVisibleCell=()=>{if(!state.view.visible)return;if(state.view.fullyVisible)return pickRandomCell();let e=state.region.left+Random.Uint32/4294967295*state.region.width,t=state.region.top+Random.Uint32/4294967295*state.region.height,l=pickCell(e,t);return l},state={grid:[],cellCount:0,ticker(){},time:0,maxTime:9999999,speed:{count:1638.4,dynamic:!1,redraw:2.5,redrawRepeatScore:.5,redrawRepeatPenalty:0},image:{data:void 0,size:void 0,baseSize:void 0},view:{height:void 0,width:void 0,iheight:void 0,iwidth:void 0,left:void 0,right:void 0,top:void 0,bottom:void 0,visible:!0,fullyVisible:!0},region:{left:0,right:1,top:0,bottom:1,width:1,height:1},camera:{x:0,y:0,dx:0,dy:0,dxTarget:0,dyTarget:0,dsControl:1,dsTargetSpeed:.05,underScale:.9,scale:.9,mscale:1,dmscale:.002,mscaleTarget:1,mscaleTargetControl:.001,mscaleTargetSpeed:.05},brush:{colour:Colour.Purple.splash,colour:Colour.Rose.splash,colour:Colour.Yellow.splash,colour:Colour.Grey.splash,colour:Colour.Green.splash,colour:999,size:3},cursor:{previous:{x:void 0,y:void 0}},dragon:{behaves:[]}};let WORLD_SIZE,WORLD_CELL_COUNT,WORLD_DIMENSION,WORLD_CELL_SIZE;const setWorldSize=e=>{WORLD_CELL_COUNT=2**(2*(WORLD_SIZE=e)),WORLD_CELL_SIZE=1/(WORLD_DIMENSION=2**WORLD_SIZE)};setWorldSize(6);const addCell=e=>{cacheCell(e),state.cellCount++},deleteCell=e=>{uncacheCell(e),e.isDeleted=!0,state.cellCount--},getCells=()=>{let e=new Set;for(let t of state.grid)for(let l of t.values())e.add(l);return e},GRID_SIZE=128;for(let x=0;x<GRID_SIZE;x++)for(let y=0;y<GRID_SIZE;y++){let e=new Set;state.grid.push(e),e.left=x/GRID_SIZE,e.top=y/GRID_SIZE,e.right=e.left+1/GRID_SIZE,e.bottom=e.top+1/GRID_SIZE,e.isSection=!0}const cacheCell=e=>{let t=Math.floor(e.left*GRID_SIZE),l=Math.floor(e.top*GRID_SIZE),i=Math.ceil(e.right*GRID_SIZE),o=Math.ceil(e.bottom*GRID_SIZE);for(let a=t;a<i;a++)for(let r=l;r<o;r++){let n=a*GRID_SIZE+r;void 0!==state.grid[n]&&(state.grid[n].add(e),e.sections.push(state.grid[n]))}},uncacheCell=e=>{for(let t of e.sections)t.delete(e)},world=makeCell({colour:111*WORLD_SIZE});addCell(world),on.load(()=>{let e=Show.start({paused:!1,scale:DPR}),{context:t,canvas:l}=e;l.style.position="absolute";let i=()=>{state.image.baseSize=Math.min(l.width,l.height),state.image.size=state.image.baseSize*state.camera.scale,state.image.left=state.camera.x*state.camera.scale,state.image.top=state.camera.y*state.camera.scale,state.image.right=state.image.left+state.image.size,state.image.bottom=state.image.top+state.image.size,state.view.left=clamp(state.image.left,0,l.width),state.view.top=clamp(state.image.top,0,l.height),state.view.right=clamp(state.image.right,0,l.width),state.view.bottom=clamp(state.image.bottom,0,l.height),state.view.width=state.view.right-state.view.left,state.view.height=state.view.bottom-state.view.top,state.view.visible=state.view.width>0&&state.view.height>0,state.view.fullyVisible=state.view.left===state.image.left&&state.view.right===state.image.right&&state.view.top===state.image.top&&state.view.bottom===state.image.bottom,state.view.iwidth=Math.ceil(state.view.width),state.view.iheight=Math.ceil(state.view.height),state.region.left=(state.view.left-state.image.left)/state.image.size,state.region.right=1+(state.view.right-state.image.right)/state.image.size,state.region.top=(state.view.top-state.image.top)/state.image.size,state.region.bottom=1+(state.view.bottom-state.image.bottom)/state.image.size,state.region.width=state.region.right-state.region.left,state.region.height=state.region.bottom-state.region.top,drawQueueNeedsReset=!0},o=()=>{state.image.data=t.getImageData(0,0,l.width,l.height)};t.fillStyle=Colour.Void,t.fillRect(0,0,l.width,l.height),i(),o(),state.camera.x+=(l.width-state.image.size)/2,state.camera.y+=(l.height-state.image.size)/2,e.resize=()=>{t.fillStyle=Colour.Void,t.fillRect(0,0,l.width,l.height),i(),o()};let a=e=>{i()},r=()=>{let e=getCells();for(let t of e.values())c(t,t.colour)},n=(e,t)=>c(e,e.colour,t),d=e=>!(e.right<=state.region.left)&&!(e.left>=state.region.right)&&!(e.bottom<=state.region.top)&&!(e.top>=state.region.bottom),h=e=>!(e.right<=state.region.left)&&!(e.left>=state.region.right)&&!(e.bottom<=state.region.top)&&!(e.top>=state.region.bottom),s=(e,t)=>(e.colour=t,h(e))?(D.add(e),O.delete(e),.01):0,c=(e,t,i=!1)=>{if(e.isDeleted||(e.colour=t,!h(e)))return 0;let o=state.image.size,a=l.width,r=state.camera.x*state.camera.scale,n=state.camera.y*state.camera.scale,d=Math.round(o*e.left+r);if(d>l.width)return 0;d<0&&(d=0);let s=Math.round(o*e.top+n);if(s>l.height)return 0;s<0&&(s=0);let c=Math.round(o*e.right+r);if(c<0)return 0;c>l.width&&(c=l.width);let u=Math.round(o*e.bottom+n);if(u<0)return 0;u>l.height&&(u=l.height);let g=Colour.splash(e.colour),$=g[0],p=g[1],f=g[2],v=4*a,m=c-d,_=4*m,w=(s*a+d)*4,b=state.image.data.data,S=Colour.Void.red,R=Colour.Void.green,C=Colour.Void.blue;if(!gridMode||m<=3||u-s<=3){S=$,R=p,C=f;for(let T=s;T<u;T++){for(let k=d;k<c;k++)b[w]=$,b[w+1]=p,b[w+2]=f,w+=4;w+=v,w-=_}return 1}let E=d+1,z=c-1,O=s+1,D=u-1;b[w]=S,b[w+1]=R,b[w+2]=C,w+=4;for(let P=E;P<z;P++)b[w]=S,b[w+1]=R,b[w+2]=C,w+=4;b[w]=S,b[w+1]=R,b[w+2]=C,w+=4,w-=_,w+=v;for(let A=O;A<D;A++){b[w]=S,b[w+1]=R,b[w+2]=C,w+=4;for(let I=E;I<z;I++)b[w]=$,b[w+1]=p,b[w+2]=f,w+=4;b[w]=S,b[w+1]=R,b[w+2]=C,w+=4,w-=_,w+=v}b[w]=S,b[w+1]=R,b[w+2]=C,w+=4;for(let B=E;B<z;B++)b[w]=S,b[w+1]=R,b[w+2]=C,w+=4;return b[w]=S,b[w+1]=R,b[w+2]=C,1},u=()=>{$(),R();let[e,t]=Mouse.position;state.cursor.previous.x=e,state.cursor.previous.y=t},g=!1,$=()=>{if(!state.worldBuilt||(Mouse.Middle||(g=!1),state.colourTode.hand.state!==tr.BRUSHING&&state.colourTode.hand.state!==tr.PENCILLING))return;if(Mouse.Middle&&!g){let[e,t]=Mouse.position;f(...p(e,t),{single:!0}),g=!0}if(!Mouse.Left)return;let[l,i]=p(...Mouse.position);if(void 0===l||void 0===i)return;let[o,a]=p(state.cursor.previous.x,state.cursor.previous.y),r=state.brush.size*WORLD_CELL_SIZE,n=l-o,d=i-a,h=Math.sign(n),s=Math.sign(d),c=Math.abs(n),u=Math.abs(d),$=Math.max(c,u),v=0,m=0;c===$?(m=WORLD_CELL_SIZE*s*(u/c),v=WORLD_CELL_SIZE*h):(v=WORLD_CELL_SIZE*h*(c/u),m=WORLD_CELL_SIZE*s);let _=new Set,w=$/WORLD_CELL_SIZE;if(0===n&&0===d)for(let b=-r/2;b<=r/2;b+=WORLD_CELL_SIZE)for(let S=-r/2;S<=r/2;S+=WORLD_CELL_SIZE)_.add([l+b,i+S]);else for(let R=0;R<=w;R++){let C=o+v*R,T=a+m*R;for(let k=-r/2;k<=r/2;k+=WORLD_CELL_SIZE)for(let E=-r/2;E<=r/2;E+=WORLD_CELL_SIZE)_.add([C+k,T+E])}for(let z of _.values())f(z[0],z[1])},p=(e,t)=>(e-=state.camera.x*state.camera.scale/DPR,t-=state.camera.y*state.camera.scale/DPR,e/=state.image.size,t/=state.image.size,[e*=DPR,t*=DPR]),f=(e,t,{single:l=!1}={})=>{let i=pickCell(e,t);if(void 0===i)return;if(!l&&(i.width!==WORLD_CELL_SIZE||i.height!=WORLD_CELL_SIZE)){let o=v(e,t);if(void 0!==o){let a=U([...o]);i=a}}if("number"==typeof state.brush.colour){i.colour=state.brush.colour,n(i);return}let r=[];for(let d of r=state.brush.colour.left[0].content.isDiagram?N(i,state.brush.colour.left[0].content):N(i,state.brush.colour))n(d)},v=(e,t)=>{let l=m(e,t),i=_(l,e,t);return i},m=(e,t)=>{let l=Math.floor(e*WORLD_DIMENSION)/WORLD_DIMENSION,i=Math.floor(t*WORLD_DIMENSION)/WORLD_DIMENSION,o=GRID_SIZE/WORLD_DIMENSION,a=new Set;for(let r=0;r<o;r++){let n=Math.floor((l+r*WORLD_CELL_SIZE/o)*GRID_SIZE);for(let d=0;d<o;d++){let h=Math.floor((i+d*WORLD_CELL_SIZE/o)*GRID_SIZE),s=n*GRID_SIZE+h,c=state.grid[s];a.add(c)}}return a},_=(e,t,l)=>{let i=new Set;for(let o of e.values())for(let a of o.values())if(!i.has(a)){for(let r of a.sections)if(!e.has(r))return;i.add(a)}return i},w,b,S;state.brush.hoverColour=Colour.Void;let R=()=>{let[e,t]=Mouse.position;if(e6.state===tr.BRUSH||e6.state===tr.BRUSHING||e6.state===tr.PENCILLING){let l=pickCell(...p(e,t));void 0!==l&&(state.brush.hoverColour=l.colour)}else{let o=tu(e/C,t/C);if(void 0!==o){if(o.isSquare||o===squareTool){if(state.brush.hoverColour=o.value,o.joinExpanded){let a=Q(o.value);a.joins=[],state.brush.hoverColour=a}}else o.isTallRectangle||(o.isPaddle?state.brush.hoverColour=o.getColour(o):o.isSlot?state.brush.hoverColour=o.parent.getColour(o.parent):state.brush.hoverColour=o.colour.splash)}else state.brush.hoverColour=Colour.Void}if(!Mouse.Right){if(void 0!==w){let r=Math.hypot(e-w,t-b),n=Date.now()-S;(n<100||r<=0)&&(state.brush.hoverColour===Colour.Void?(++brushColourCycleIndex>=brushColourCycle.length&&(brushColourCycleIndex=0),tO(brushColourCycle[brushColourCycleIndex])):tO(state.brush.hoverColour),squareTool.toolbarNeedsColourUpdate=!0),drawQueueNeedsReset=!0}w=void 0,b=void 0;return}if(drawQueueNeedsReset=!0,void 0===w&&(w=e,b=t,S=Date.now(),dropperMovement=0),e6.state===tr.FREE||e6.state==tr.VOIDING||e6.state===tr.BRUSH||e6.state===tr.BRUSHING||e6.state===tr.PENCILLING){let{x:d,y:h}=state.cursor.previous;if(void 0===d||void 0===h||void 0===e||void 0===t)return;let[s,c]=[e-d,t-h];state.camera.x+=s/state.camera.scale,state.camera.y+=c/state.camera.scale,i()}},C=DPR*SCALE;on.wheel(e=>{e.preventDefault();let t=e.deltaY/100;if(e.altKey)li.scroll-=50*t,lf();else if(e.ctrlKey||e.metaKey){C-=.1*t;let l=l$();for(let i of l)i.needsColoursUpdate=!0;squareTool.toolbarNeedsColourUpdate=!0}else e.shiftKey?(0===t&&(t=e.deltaX/100),state.brush.size-=Math.sign(t),state.brush.size<0&&(state.brush.size=0)):k(t,...Mouse.position)},{passive:!1}),on.keydown(e=>{"Alt"===e.key&&e.preventDefault()},{passive:!1}),on.keydown(e=>{"f"===e.key&&(state.camera.x=640,state.camera.y=30,state.camera.scale=.95,i())});let T=e=>e,k=(e,t,l)=>{t*=DPR,l*=DPR;let o=-Math.sign(e),a=Math.abs(e);for(let r=0;r<a;r++){let n=.02*state.camera.underScale,d=n*o;state.camera.underScale+=d;let h=state.camera.scale,s=T(state.camera.underScale);state.camera.scale=s;let c=s/h;state.camera.x+=(1-c)*t/s,state.camera.y+=(1-c)*l/s}i()};on.contextmenu(e=>{e.preventDefault()}),on.keydown(e=>{let t=E[e.key];void 0!==t&&t(e)});let E={};E.e=()=>state.camera.mscaleTarget+=state.camera.mscaleTargetControl,E.q=()=>state.camera.mscaleTarget-=state.camera.mscaleTargetControl,E.w=()=>state.camera.dyTarget+=state.camera.dsControl,E.s=e=>{e.ctrlKey||e.metaKey||(state.camera.dyTarget-=state.camera.dsControl)},E.a=()=>state.camera.dxTarget+=state.camera.dsControl,E.d=()=>state.camera.dxTarget-=state.camera.dsControl,E[0]=()=>setWorldSize(0),E[1]=()=>setWorldSize(1),E[2]=()=>setWorldSize(2),E[3]=()=>setWorldSize(3),E[4]=()=>setWorldSize(4),E[5]=()=>setWorldSize(5),E[6]=()=>setWorldSize(6),E[7]=()=>setWorldSize(7),E[8]=()=>setWorldSize(8),E[9]=()=>setWorldSize(9),E.r=()=>{state.camera.mscaleTarget=1,state.camera.dxTarget=0,state.camera.dyTarget=0},E["="]=()=>edgeMode=1,E["-"]=()=>edgeMode=0,E.o=()=>edgeMode=0===edgeMode?1:0,gridMode=!0,E.g=()=>{gridMode=!gridMode,drawQueueNeedsReset=!0};let z=()=>{if(state.camera.mscale!==state.camera.mscaleTarget){let e=state.camera.mscaleTarget-state.camera.mscale;state.camera.mscale+=e*state.camera.mscaleTargetSpeed;let t=Math.sign(e),o=state.camera.mscaleTarget*state.camera.mscaleTargetControl*state.camera.mscaleTargetSpeed;1===t&&state.camera.mscale>state.camera.mscaleTarget-o&&(state.camera.mscale=state.camera.mscaleTarget),-1===t&&state.camera.mscale<state.camera.mscaleTarget+o&&(state.camera.mscale=state.camera.mscaleTarget)}if(state.camera.dx!==state.camera.dxTarget){let a=state.camera.dxTarget-state.camera.dx;state.camera.dx+=a*state.camera.dsTargetSpeed;let r=Math.sign(a),n=state.camera.dxTarget*state.camera.dsControl*state.camera.dsTargetSpeed;1===r&&state.camera.dx>state.camera.dxTarget-n&&(state.camera.dx=state.camera.dxTarget),-1===r&&state.camera.dx<state.camera.dxTarget+n&&(state.camera.dx=state.camera.dxTarget)}if(state.camera.dy!==state.camera.dyTarget){let d=state.camera.dyTarget-state.camera.dy;state.camera.dy+=d*state.camera.dsTargetSpeed;let h=Math.sign(d),s=state.camera.dyTarget*state.camera.dsControl*state.camera.dsTargetSpeed;1===h&&state.camera.dy>state.camera.dyTarget-s&&(state.camera.dy=state.camera.dyTarget),-1===h&&state.camera.dy<state.camera.dyTarget+s&&(state.camera.dy=state.camera.dyTarget)}if((0!==state.camera.dx||0!==state.camera.dy)&&(state.camera.x+=state.camera.dx,state.camera.y+=state.camera.dy,i(),e6.state.camerapan&&e6.state.camerapan()),1!==state.camera.mscale){let c=state.camera.scale;state.camera.scale*=state.camera.mscale;let u=state.camera.scale,g=u/c,$=Mouse.position[0],p=Mouse.position[1];void 0===$&&($=l.width/2),void 0===p&&(p=l.height/2),state.camera.x+=(1-g)*$/u,state.camera.y+=(1-g)*p/u,i()}};r(),e.tick=()=>{te(),u(),z(),drawQueueNeedsReset&&(A(),drawQueueNeedsReset=!1),e.paused?B():I(),t.putImageData(state.image.data,0,0),t.clearRect(0,0,state.view.left,state.view.bottom),t.clearRect(state.view.left,0,l.width,state.view.top),t.clearRect(state.view.right,state.view.top,l.width,l.height),t.clearRect(0,state.view.bottom,l.width,l.height),state.time++,state.time>state.maxTime&&(state.time=0)};let O=new Set,D=new Set;drawQueueNeedsReset=!1;let P=e=>{for(let t=e.length-1;t>0;t--){let l=Random.Uint32%(t+1);[e[t],e[l]]=[e[l],e[t]]}return e},A=()=>{for(let e of(O.clear(),P([...state.grid])))if(d(e))for(let t of e.values())O.add(t)},I=()=>{let e=state.speed.dynamic?state.speed.aer*state.cellCount:state.speed.count;e=Math.min(e,state.cellCount),e*=state.worldBuilt?1:.1;let t=e*state.speed.redraw,l=!0;state.worldBuilt||(l=!1);let i=0;for(let o=0;o<e;o++){let a=pickRandomCell();l&&i>=t&&(l=!1);let r=L(a,l);i+=r}for(let d of D)if(i+=n(d),D.delete(d),i>=t)break;for(let h of O)if(i+=n(h),O.delete(h),i>=t)break},B=()=>{if(!state.view.visible)return;let e=state.speed.dynamic?state.speed.aer*state.cellCount:state.speed.count,t=e*state.speed.redraw;state.worldBuilt||(t=1);let l=0;for(let i of O)if(l+=n(i),O.delete(i),l>=t)break},L=(e,t)=>{if(void 0!==Y(e,t))return 1;for(let l of(state.dragon.behaves.shuffle(),state.dragon.behaves)){let i=l(e,t);if(void 0!==i)return i}return 0},G=(e,t,l)=>{let i=e.width/t,o=e.height/l,a=[],r=e.x,n=e.y,d=i,h=o;for(let s=0;s<t;s++){let c=r+d*s;for(let u=0;u<l;u++){let g=n+h*u,$=makeCell({x:c,y:g,width:i,height:o,colour:e.colour,lastDraw:e.lastDraw});a.push($)}}for(let p of(deleteCell(e),a))addCell(p);return a},N=(e,t)=>{let[l,i]=eo(t),o=e.width/l,a=e.height/i,r=[];for(let n of t.left){let d=M(n.content,{source:e.colour}),h=d[Random.Uint32%d.length],s=makeCell({x:e.x+n.x*o,y:e.y+n.y*a,width:n.width*o,height:n.height*a,colour:h});r.push(s)}for(let c of(deleteCell(e),r))addCell(c);return r},U=e=>{let t=1,l=1,i=0,o=0;for(let a of e)a.left<t&&(t=a.left),a.top<l&&(l=a.top),a.right>i&&(i=a.right),a.bottom>o&&(o=a.bottom),deleteCell(a);let r=makeCell({x:t,y:l,width:i-t,height:o-l,colour:e[0].colour,lastDraw:e[0].lastDraw});return addCell(r),r},Y=(e,t)=>{if(state.worldBuilt)return;if(state.cellCount>=WORLD_CELL_COUNT){state.worldBuilt=!0;return}if(e.colour<111)return 0;e.colour-=111;let l=2,i=2,o=G(e,l,i);for(let a of o)n(a);return 1},X=({values:e,channel:t=0,variable:l,add:i,subtract:o}={})=>{let a;return{values:a=void 0!==l?[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0]:e,variable:l,channel:t,add:i,subtract:o}},H=e=>{let t=[...e.values],l=e.variable,i=e.channel,o=void 0===e.add?void 0:H(e.add),a=void 0===e.subtract?void 0:H(e.subtract),r=X({values:t,variable:l,channel:i,add:o,subtract:a});return r},V=e=>{let t=[!1,!1,!1,!1,!1,!1,!1,!1,!1,!1];return t[e]=!0,t},j=e=>{let t=V(e);return X({values:t})},W={};W.red=(e,{source:t}={})=>{if(void 0===t)return[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0];let[l,i,o]=getRGB(t),a=V(l/100);return a},W.green=(e,{source:t}={})=>{if(void 0===t)return[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0];let[l,i,o]=getRGB(t),a=V(i/10);return a},W.blue=(e,{source:t}={})=>{if(void 0===t)return[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0];let[l,i,o]=getRGB(t),a=V(o);return a};let q=(e,t={})=>{if(void 0===e.variable)return e.values;let l=W[e.variable](e,t),i="red"===e.variable;return void 0!==e.add&&(l=e$(l,e.add,{source:t.source,multiplier:1,isHue:i})),void 0!==e.subtract&&(l=e$(l,e.subtract,{source:t.source,multiplier:-1,isHue:i})),l},Z=({channels:e,stamp:t,joins:l=[]}={})=>(void 0===e&&(e=[void 0,void 0,void 0]),{channels:e,stamp:t,joins:l});makeArrayFromSplash=e=>{let[t,l,i]=getRGB(e);t/=100,l/=10;let o=[!1,!1,!1,!1,!1,!1,!1,!1,!1,!1],a=[!1,!1,!1,!1,!1,!1,!1,!1,!1,!1],r=[!1,!1,!1,!1,!1,!1,!1,!1,!1,!1];o[t]=!0,a[l]=!0,r[i]=!0;let n=X({values:o,channel:0}),d=X({values:a,channel:1}),h=X({values:r,channel:2}),s=Z({channels:[n,d,h]});return s};let F=(e,t)=>{let l=M(e,t),i=new Set(l);return i},M=(e,t={})=>{let l=[];for(let i of e.joins){let o=M(i);l.push(...o)}if(e.isDiagram)return l.push(900),l;let[a,r,n]=e.channels;void 0===a&&(a=X({channel:0,variable:"red"})),void 0===r&&(r=X({channel:1,variable:"green"})),void 0===n&&(n=X({channel:2,variable:"blue"}));let d=q(a,t),h=q(r,t),s=q(n,t);for(let c=0;c<d.length;c++){let u=d[c];if(u)for(let g=0;g<h.length;g++){let $=h[g];if($)for(let p=0;p<s.length;p++){let f=s[p];if(!f)continue;let v=100*c+10*g+1*p;l.push(v)}}}return l},K=e=>{for(let t=0;t<3;t++)void 0===e.channels[t]&&(e.channels[t]=X({channel:t,variable:t9[t]}))},J=e=>{for(let t of e.channels){if(void 0===t)break;if(void 0!==t.variable)return!0}return!1},Q=e=>{if(void 0===e){let t=X({values:[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0],channel:0}),l=X({values:[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0],channel:1}),i=X({values:[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0],channel:2}),o=Z({channels:[t,l,i]});return o}if(e.isDiagram)return ee(e);let a,r,n,d=e.stamp;void 0!==e.channels[0]&&null!==e.channels[0]&&(a=H(e.channels[0])),void 0!==e.channels[1]&&null!==e.channels[1]&&(r=H(e.channels[1])),void 0!==e.channels[2]&&null!==e.channels[2]&&(n=H(e.channels[2]));let h=[];for(let s of e.joins){let c=Q(s);h.push(c)}let u=Z({stamp:d,channels:[a,r,n],joins:h});return u};makeDiagram=({left:e=[],right:t,joins:l=[]}={})=>({left:e,right:t,isDiagram:!0,joins:l});let ee=e=>{let t=makeDiagram();for(let l of["left","right"]){if(void 0===e[l])continue;let i=[];for(let o of e[l]){let a=et(o);i.push(a)}t[l]=i}return t};makeDiagramCell=({x:e=0,y:t=0,width:l=1,height:i=1,content:o=Z(),instruction:a=DRAGON_INSTRUCTION.recolour,splitX:r=1,splitY:n=1}={})=>({x:e,y:t,width:l,height:i,content:o,instruction:a,splitX:r,splitY:n});let et=e=>{let t=Q(e.content);return{...e,content:t}},el=e=>{let[t,l]=eo(e);for(let i of["left","right"]){let o=e[i];if(void 0!==o)for(let a of o)a.width/=t,a.height/=l,a.x/=t,a.y/=l}return e},ei=e=>{let t=1/0,l=1/0;for(let i of["left","right"]){let o=e[i];if(void 0!==o)for(let a of o)a.width<t&&(t=a.width),a.height<l&&(l=a.height)}let r=makeDiagram({joins:e.joins});for(let n of["left","right"]){let d=e[n];if(void 0!==d)for(let h of(void 0===r[n]&&(r[n]=[]),d)){let s=et(h);s.width/=t,s.height/=l,s.x/=t,s.y/=l,r[n].push(s)}}return r},eo=e=>{let t=1/0,l=-1/0,i=1/0,o=-1/0;for(let a of e.left){let r=a.x,n=a.x+a.width,d=a.y,h=a.y+a.height;r<t&&(t=r),d<i&&(i=d),n>l&&(l=n),h>o&&(o=h)}let s=l-t,c=o-i;return[s,c]};makeRule=({steps:e=[],transformations:t=DRAGON_TRANSFORMATIONS.NONE,locked:l=!0,chance:i}={})=>({steps:e,transformations:t,locked:l,chance:i}),DRAGON_TRANSFORMATIONS={NONE:[(e,t,l,i,o,a)=>[e,t],],X:[(e,t,l,i,o,a)=>[e,t],(e,t,l,i,o,a)=>[-e-l+o,t],],Y:[(e,t,l,i,o,a)=>[e,t],(e,t,l,i,o,a)=>[e,-t-i+a],],XY:[(e,t,l,i,o,a)=>[e,t],(e,t,l,i,o,a)=>[-e-l+o,t],(e,t,l,i,o,a)=>[e,-t-i+a],(e,t,l,i,o,a)=>[-e-l+o,-t-i+a],],R:[(e,t,l,i,o,a)=>[e,t],(e,t,l,i,o,a)=>[-t-i+a,e],(e,t,l,i,o,a)=>[-e-l+o,-t-i+a],(e,t,l,i,o,a)=>[t,-e-l+o],],XYR:[(e,t,l,i,o,a)=>[e,t],(e,t,l,i,o,a)=>[-t-i+a,e],(e,t,l,i,o,a)=>[-e-l+o,-t-i+a],(e,t,l,i,o,a)=>[t,-e-l+o],(e,t,l,i,o,a)=>[-e-l+o,t],(e,t,l,i,o,a)=>[-t-i+a,-e-l+o],(e,t,l,i,o,a)=>[e,-t-i+a],(e,t,l,i,o,a)=>[t,e],]};let ea=(e,t,l)=>{let[i,o]=eo(e.steps[0]),a=e.steps.map(e=>er(e,t,l,i,o)),r=makeRule({steps:a,transformations:e.transformations,locked:e.locked,chance:e.chance});return r},er=(e,t,l,i,o)=>{let{left:a,right:r}=e,[n,d]=[i,o],h=[],s=void 0===r?void 0:[];for(let c=0;c<a.length;c++){let u=a[c],g=en(u,t,n,d,l);h.push(g)}for(let $=0;$<r.length;$++){let p=r[$],f=en(p,t,n,d,l);s.push(f)}for(let v=0;v<s.length;v++){let m=s[v];if("SPLIT"!==m.instruction.type)continue;let _=m.splitX*m.splitY,w=s.slice(v+1,v+1+_),b=lc(w);s.splice(v+1,_,...b)}let S=makeDiagram({left:h,right:s});return S},en=(e,t,l,i,o=!1)=>{let[a,r,n,d]=t(e.x,e.y,e.width,e.height,l,i),{splitX:h,splitY:s}=e;if(!o){let[c,u]=t(e.splitX,e.splitY,1,1,1,1).map(e=>Math.abs(e));h=c,s=u;let[g,$]=t(e.width,e.height,1,1,1,1).map(e=>Math.abs(e));n=g,d=$}void 0===a&&(a=e.x),void 0===r&&(r=e.y),void 0===n&&(n=e.width),void 0===d&&(d=e.height);let p=e.content;return makeDiagramCell({x:a,y:r,splitX:h,splitY:s,width:n,height:d,content:p,instruction:e.instruction})};registerRule=e=>{let t=[];for(let l of e.transformations){let i=ea(e,l);t.push(i)}let o=[];for(let a of t){let r=eh(a);o.push(...r)}let n=[];for(let d of o){let h=ec(d);n.push(h),state.dragon.behaves.push(h)}return{redundantRules:o,transformedRules:t,behaveFunctions:n}};let ed=({behaveFunctions:e})=>{state.dragon.behaves=state.dragon.behaves.filter(t=>!e.includes(t))},eh=e=>{let t=[],[l]=e.steps;for(let i of l.left){let o=(e,t,l=1,o=1)=>{let a=l/i.width,r=o/i.height,n=(e-i.x)*1/i.width,d=(t-i.y)*1/i.height;return[n,d,a,r]},a=ea(e,o,!0);t.push(a)}return t},es=e=>{let t=new Set,l=[e.left,e.right];for(let i of l)for(let o of i){let a=o.content.stamp;void 0!==a&&t.add(a)}return[...t.values()]},ec=e=>{let t=[];for(let l of e.steps){let i=es(l),o=eu(l,i,e.chance),a=eg(l,i),r=(e,t)=>{let[l,i]=o(e);if(void 0!==l)return a(l,t,i)};t.push(r)}let n=(e,l)=>{for(let i of t){let o=i(e,l);if(void 0!==o)return o}};return n},eu=(e,t,l=6)=>{let i=[];for(let o of e.left){let a=F(o.content),r=e=>{let t=o.width*e.width,l=o.height*e.height,i=e.x+o.x*e.width,r=e.y+o.y*e.height;if(1===edgeMode){for(;i>=1;)i-=1;for(;r>=1;)r-=1;for(;i<0;)i+=1;for(;r<0;)r+=1}let n=i+t/2,d=r+l/2,h=pickCell(n,d);return void 0!==h&&h.left===i&&h.top===r&&h.width===t&&h.height===l&&a.has(h.colour)?[h,o.content.stamp]:[void 0,void 0]};i.push(r)}let n=Math.round(10**(3-l/2)),d=()=>oneIn(n),h=e=>{if(void 0!==l&&!d())return[void 0,void 0];let o=[],a={};for(let r of t)a[r]=[];for(let n of i){let[h,s]=n(e);if(void 0===h)return[void 0,void 0];void 0!==s&&a[s].push(h.colour),o.push(h)}return[o,a]};return h},eg=(e,t)=>{let l=[];for(let i of e.right){let o=i.instruction(i);l.push(o)}let a=(e,t,l)=>{for(let i of l)r(e,t,i)},r=(e,t,l)=>{e[l]=[...t[l]]};return(e,i,o)=>{let n=0,d=0,h=0,s=[],c={};for(let u of(a(c,o,t),l)){let g=s.length>0?s.pop():e[d],$=u(g,i,e,d,c);void 0!==$.stampNameTakenFrom&&0===c[$.stampNameTakenFrom].length&&r(c,o,$.stampNameTakenFrom);let{drawn:p,bonusTargets:f,skip:v}=$;void 0!==v&&(h+=v),n+=p,void 0!==f&&s.push(...f),0===s.length&&(d++,h>0&&(d++,h--))}return n}};(DRAGON_INSTRUCTION={}).nothing=e=>()=>({drawn:0}),DRAGON_INSTRUCTION.nothing.type="NOTHING",DRAGON_INSTRUCTION.recolour=e=>{K(e.content);let t=M(e.content),l=J(e.content),i=(i,o,a,r,n)=>{let d,h=i.colour,c;if(void 0===e.content.stamp)d=t[Random.Uint32%t.length];else{let u=n[e.content.stamp];if(0===u.length)d=t[Random.Uint32%t.length];else{let g=Random.Uint32%u.length;d=h=u[g],u.splice(g,1),c=e.content.stamp}}if(l){let $=getRGB(d);for(let p=0;p<e.content.channels.length;p++){let f=e.content.channels[p];if(void 0===f.variable)continue;let v=W[f.variable](f,{source:h}),m="red"===f.variable;void 0!==f.add&&(v=e$(v,f.add,{source:h,multiplier:1,isHue:m})),void 0!==f.subtract&&(v=e$(v,f.subtract,{source:h,multiplier:-1,isHue:m}));let _=v.map((e,t)=>!0===e&&t).filter(e=>!1!==e),w=_[Random.Uint8%_.length];d-=$[p];let b=10**(2-p);d+=w*b}}let S=0;return o?S+=s(i,d,!0):i.colour=d,{drawn:S,stampNameTakenFrom:c}};return i},DRAGON_INSTRUCTION.recolour.type="RECOLOUR";let e$=(e,t,{source:l,multiplier:i=1,isHue:o=!1})=>{let a=t.values;void 0!==t.variable&&(a=W[t.variable](t,{source:l}));let r=a.map((e,t)=>!0===e&&t).filter(e=>!1!==e),n=e.map((e,t)=>!0===e&&t).filter(e=>!1!==e),d=new Set;for(let h of n)for(let s of r){let c=clamp(h+s*i,0,9);d.add(c)}let u=[!1,!1,!1,!1,!1,!1,!1,!1,!1,!1];for(let g of d)u[g]=!0;return void 0!==t.add&&(u=e$(u,t.add,{source:l,multiplier:1,isHue:o})),void 0!==t.subtract&&(u=e$(u,t.add,{source:l,multiplier:-1,isHue:o})),u};DRAGON_INSTRUCTION.split=e=>{let t=(t,l,i,o,a)=>{let r=G(t,e.splitX,e.splitY);return{drawn:0,bonusTargets:r.reverse()}};return t},DRAGON_INSTRUCTION.split.type="SPLIT",DRAGON_INSTRUCTION.merge=e=>{let t=Math.abs(e.splitX)*Math.abs(e.splitY),l=(e,l,i,o,a)=>{let r=i.slice(o,o+t),n=U(r);return{drawn:0,skip:t-1,bonusTargets:[n]}};return l},DRAGON_INSTRUCTION.merge.type="MERGE";debugRegistry=(e,{transforms:t=!0,redundants:l=!0}={})=>{let{redundantRules:i,transformedRules:o}=e;if(print(""),print("================================================================="),t)for(let a of(print(""),print("TRANSFORMED RULES"),o))debugRule(a);if(l)for(let r of(print(""),print("REDUNDANT RULES"),i))debugRule(r)},debugRule=e=>{for(let t of e.steps){for(let l of(print(""),print("=== LEFT ==="),t.left))debugDiagramCell(l,{read:!0});for(let i of(print("=== RIGHT ==="),t.right))debugDiagramCell(i)}},debugDiagramCell=(e,{read:t=!1}={})=>{t?print("CHECK","at",e.x,e.y,"with size",e.width,e.height,"for",M(e.content)):"NOTHING"===e.instruction.type?print(e.instruction.type,"at",e.x,e.y,"with size",e.width,e.height):"RECOLOUR"===e.instruction.type?print(e.instruction.type,"at",e.x,e.y,"with size",e.width,e.height,"to",M(e.content)):print(e.instruction.type,e.splitX,e.splitY,"at",e.x,e.y,"with size",e.width,e.height)};let ep=makeArrayFromSplash(Colour.Grey.splash),ef=makeArrayFromSplash(Colour.Black.splash),ev=makeArrayFromSplash(Colour.Cyan.splash),em=makeArrayFromSplash(Colour.Blue.splash),ey=makeArrayFromSplash(Colour.Yellow.splash),e_=makeArrayFromSplash(Colour.Cyan.splash-111),ex=makeArrayFromSplash(Colour.Red.splash),[ew,eb,e0]=getRGB(Colour.Red.splash);ew/=100,eb/=10;let eS=makeDiagram({left:[makeDiagramCell({x:0,y:0,content:ep}),makeDiagramCell({x:0,y:1,content:ef}),],right:[makeDiagramCell({x:0,y:0,content:ef}),makeDiagramCell({x:0,y:1,content:ep}),]}),eR=makeDiagram({left:[makeDiagramCell({x:0,y:0,content:ey}),makeDiagramCell({x:0,y:1,content:ef}),],right:[makeDiagramCell({x:0,y:0,content:ef}),makeDiagramCell({x:0,y:1,content:ey}),]}),eC=makeDiagram({left:[makeDiagramCell({x:0,y:0,content:ey}),makeDiagramCell({x:1,y:1,content:ef}),],right:[makeDiagramCell({x:0,y:0,content:ef}),makeDiagramCell({x:1,y:1,content:ey}),]}),eT=makeDiagram({left:[makeDiagramCell({x:0,y:0,content:ev}),makeDiagramCell({x:1,y:0,content:em}),]}),ek=makeDiagram({left:[makeDiagramCell({x:0,y:0,content:em}),makeDiagramCell({x:0,y:1,content:ef}),],right:[makeDiagramCell({x:0,y:0,content:ef}),makeDiagramCell({x:0,y:1,content:em}),]}),eE=makeDiagram({left:[makeDiagramCell({x:0,y:0,content:e_}),makeDiagramCell({x:1,y:0,content:ev}),],right:[makeDiagramCell({x:0,y:0,content:ev}),makeDiagramCell({x:1,y:0,content:e_}),]}),ez=makeDiagram({left:[makeDiagramCell({x:0,y:0,width:1,content:em}),],right:[makeDiagramCell({x:0,y:0,width:.5,content:e_,instruction:DRAGON_INSTRUCTION.split,splitX:2,splitY:1}),makeDiagramCell({x:.5,y:0,width:.5,content:ev}),]}),eO=makeDiagram({left:[makeDiagramCell({x:0,y:0,width:1,content:e_}),makeDiagramCell({x:1,y:0,width:1,content:ev}),makeDiagramCell({x:0,y:1,width:2,content:ef}),],right:[makeDiagramCell({x:0,y:0,width:2,content:em,instruction:DRAGON_INSTRUCTION.merge,splitX:2,splitY:1}),makeDiagramCell({x:0,y:1,width:2,content:ef}),]}),eD=makeDiagram({left:[makeDiagramCell({x:0,y:0,width:1,content:e_}),makeDiagramCell({x:1,y:0,width:1,content:e_}),],right:[makeDiagramCell({x:0,y:0,width:2,content:em,instruction:DRAGON_INSTRUCTION.merge,splitX:2,splitY:1}),]}),eP=makeDiagram({left:[makeDiagramCell({x:0,y:0,width:1,content:ev}),makeDiagramCell({x:1,y:0,width:1,content:ev}),],right:[makeDiagramCell({x:0,y:0,width:2,content:em,instruction:DRAGON_INSTRUCTION.merge,splitX:2,splitY:1}),]}),eA=makeDiagram({left:[makeDiagramCell({x:0,y:0,width:1,content:e_}),makeDiagramCell({x:1,y:0,width:1,content:ev}),makeDiagramCell({x:2,y:0,width:2,content:ef}),],right:[makeDiagramCell({x:0,y:0,width:2,content:ef,instruction:DRAGON_INSTRUCTION.merge,splitX:2,splitY:1}),makeDiagramCell({x:2,y:0,width:1,content:e_,instruction:DRAGON_INSTRUCTION.split,splitX:2,splitY:1}),makeDiagramCell({x:3,y:0,width:1,content:ev}),]}),eI=makeDiagram({left:[makeDiagramCell({x:0,y:0,width:.5,content:em}),makeDiagramCell({x:.5,y:0,width:.5,content:em}),makeDiagramCell({x:0,y:1,content:ef}),],right:[makeDiagramCell({x:0,y:0,width:1,content:ef,instruction:DRAGON_INSTRUCTION.merge,splitX:2,splitY:1}),makeDiagramCell({x:0,y:1,width:.5,content:em,instruction:DRAGON_INSTRUCTION.split,splitX:2,splitY:1}),makeDiagramCell({x:.5,y:1,width:.5,content:em}),]}),eB=makeDiagram({left:[makeDiagramCell({x:0,y:0,width:.5,content:ev}),makeDiagramCell({x:.5,y:0,width:.5,content:ev}),makeDiagramCell({x:0,y:1,content:ef}),],right:[makeDiagramCell({x:0,y:0,width:1,content:ef,instruction:DRAGON_INSTRUCTION.merge,splitX:2,splitY:1}),makeDiagramCell({x:0,y:1,width:.5,content:ev,instruction:DRAGON_INSTRUCTION.split,splitX:2,splitY:1}),makeDiagramCell({x:.5,y:1,width:.5,content:ev}),]}),eL=makeDiagram({left:[makeDiagramCell({x:0,y:0,content:em}),makeDiagramCell({x:1,y:0,content:ev}),],right:[makeDiagramCell({x:0,y:0,content:ev}),makeDiagramCell({x:1,y:0,content:em}),]}),eG=makeDiagram({left:[makeDiagramCell({x:0,y:0,content:e_}),],right:[makeDiagramCell({x:0,y:0,width:.5,content:em,instruction:DRAGON_INSTRUCTION.split,splitX:2,splitY:1}),makeDiagramCell({x:.5,y:0,width:.5,content:ev,instruction:DRAGON_INSTRUCTION.recolour}),]}),eN=makeDiagram({left:[makeDiagramCell({x:0,y:0,width:1,content:em}),makeDiagramCell({x:1,y:0,width:1,content:em}),],right:[makeDiagramCell({x:0,y:0,width:1,content:em}),makeDiagramCell({x:1,y:0,width:1,content:ev}),]}),eU=makeDiagram({left:[makeDiagramCell({x:0,y:0,width:1,content:ev}),makeDiagramCell({x:1,y:0,width:1,content:ev}),],right:[makeDiagramCell({x:0,y:0,width:1,content:em}),makeDiagramCell({x:1,y:0,width:1,content:ev}),]}),e7=makeDiagram({left:[makeDiagramCell({x:0,y:0,width:1,content:ep}),makeDiagramCell({x:0,y:1,width:1,content:ef}),],right:[makeDiagramCell({x:0,y:0,width:1,content:ef}),makeDiagramCell({x:0,y:1,width:1,content:ep}),]}),eY=makeDiagram({left:[makeDiagramCell({x:0,y:0,width:1,content:ep}),makeDiagramCell({x:1,y:0,width:1,content:ef}),],right:[makeDiagramCell({x:0,y:0,width:1,content:ef}),makeDiagramCell({x:1,y:0,width:1,content:ep}),]}),eX=Z();eX.channels=[X(),X(),X()];for(let e3=0;e3<3;e3++){let e1=eX.channels[e3];for(let eH=0;eH<10;eH++)0===e3&eH>0||(e1.values[eH]=!0)}RAINBOW_DIAGRAM=makeDiagram({left:[makeDiagramCell({content:eX})]});let e8=Z();e8.channels=[X(),X(),X()];for(let eV=0;eV<3;eV++){let ej=e8.channels[eV];for(let eW=0;eW<10;eW++)1===eV&eW>0||(ej.values[eW]=!0)}RAINBOW_DIAGRAM_2=makeDiagram({left:[makeDiagramCell({content:e8})]});let eq=makeDiagram({left:[makeDiagramCell({x:0,y:0,content:e_}),],right:[makeDiagramCell({x:0,y:0,content:ev}),]}),e2=makeDiagram({left:[makeDiagramCell({x:0,y:0,content:e_}),],right:[makeDiagramCell({x:0,y:0,content:em}),]}),eZ=makeDiagram({left:[makeDiagramCell({x:0,y:0,content:ev}),makeDiagramCell({x:0,y:1,content:ef}),],right:[makeDiagramCell({x:0,y:0,content:ef}),makeDiagramCell({x:0,y:1,content:ev}),]}),eF=makeDiagram({left:[makeDiagramCell({x:0,y:0,content:em}),makeDiagramCell({x:0,y:1,content:ef}),],right:[makeDiagramCell({x:0,y:0,content:ef}),makeDiagramCell({x:0,y:1,content:em}),]}),e4=makeDiagram({left:[makeDiagramCell({x:0,y:0,content:em}),makeDiagramCell({x:1,y:0,content:ef}),],right:[makeDiagramCell({x:0,y:0,content:ef}),makeDiagramCell({x:1,y:0,content:em}),]}),eM=makeDiagram({left:[makeDiagramCell({x:0,y:0,content:ev}),makeDiagramCell({x:-1,y:0,content:ef}),],right:[makeDiagramCell({x:0,y:0,content:ef}),makeDiagramCell({x:-1,y:0,content:ev}),]}),e5=makeDiagram({left:[makeDiagramCell({x:0,y:0,content:em}),],right:[makeDiagramCell({x:0,y:0,content:ev}),]}),eK=makeDiagram({left:[makeDiagramCell({x:0,y:0,content:ev}),],right:[makeDiagramCell({x:0,y:0,content:em}),]});state.colourTode={atoms:[],hand:{state:void 0,content:void 0,offset:{x:0,y:0},velocity:{x:0,y:0},velocityHistory:[],velocityMemory:5,previous:{x:0,y:0}}};let e6=state.colourTode.hand,e9=document.createElement("canvas"),eJ=e9.getContext("2d");e9.style.position="absolute",e9.style.top="0px",document.body.append(e9),on.resize(()=>{e9.width=innerWidth*DPR,e9.height=innerHeight*DPR,e9.style.width=innerWidth,e9.style.height=innerHeight}),trigger("resize");let eQ=()=>{tl(),ta(),requestAnimationFrame(eQ)},te=()=>{if(e6.velocityHistory.length>=e6.velocityMemory&&e6.velocityHistory.shift(),void 0!==Mouse.position&&void 0!==Mouse.position[0]&&void 0!==e6.previous.x){let[e,t]=Mouse.position.map(e=>e/C),l=(e-e6.previous.x)*DPR,i=(t-e6.previous.y)*DPR,o={x:l,y:i};e6.velocityHistory.push(o);let a=e6.velocityHistory.reduce((e,t)=>({x:e.x+t.x,y:e.y+t.y}),{x:0,y:0}),r={x:a.x/e6.velocityHistory.length,y:a.y/e6.velocityHistory.length};e6.velocity.x=r.x,e6.velocity.y=r.y,e6.previous.x=e,e6.previous.y=t}},tt=.9,tl=()=>{for(let e of state.colourTode.atoms)ti(e)},ti=(e,t=!0)=>{for(let l of e.children)ti(l,!1);if(void 0!==e.hover&&to(e),e.update(e),e6.content===e||0===e.dx&&0===e.dy)return;if(e.x+=e.dx,e.y+=e.dy,e.x=clamp(e.x,e.minX,e.maxX),e.y=clamp(e.y,e.minY,e.maxY),e.dx*=tt,e.dy*=tt,t&&tf(e)){t$(e);return}let[i,o]=Mouse.position.map(e=>e/C);e6.state.atommove&&e6.state.atommove(e,i,o)},to=e=>{if(e.highlightedAtom=void 0,e6.content!==e||e6.state!==tr.DRAGGING)return;void 0!==e.highlight&&(tb(e,e.highlight),e.highlight=void 0);let t=e.hover(e);if(void 0!==t){if(void 0===e.highlight){let l=tw(e,lS,{bottom:!0});l.hasBorder=!0,l.colour=Colour.Grey;let{x:i,y:o}=tx(t);l.x=i,l.y=o,l.width=t.width,l.height=t.height,e.highlight=l}e.highlightedAtom=t}},ta=()=>{for(let e of(eJ.clearRect(0,0,e9.width,e9.height),eJ.scale(C,C),state.colourTode.atoms))tg(e);eJ.scale(1/C,1/C)};requestAnimationFrame(eQ);let tr={};HAND_RELEASE=.5,tr.FREE={cursor:"auto",mousemove(e){let t=e.clientX/C,l=e.clientY/C,i=tu(t,l);if(void 0!==i){i.grabbable&&(Mouse.Left?i.grabbable&&i.draggable&&(tm(i,t,l),e6.pityStartX=e.clientX,e6.pityStartY=e.clientY,e6.pityStartT=Date.now(),th(tr.TOUCHING),tr.TOUCHING.mousemove(e)):void 0!==i.cursor?th(tr.HOVER,i.cursor(i,tr.HOVER)):i.dragOnly?th(tr.HOVER,"move"):th(tr.HOVER));return}let[o,a]=Mouse.position;o*=DPR,a*=DPR,!(o<state.view.left)&&!(o>state.view.right)&&!(a<state.view.top)&&!(a>state.view.bottom)&&(Mouse.Left?th(tr.BRUSHING):Mouse.Middle?th(tr.PENCILLING):th(tr.BRUSH))},mousedown(e){state.worldBuilt&&(e6.voidingStart=[e.clientX,e.clientY],th(tr.VOIDING))},atommove(e,t,l){if(e.grabbable&&tv(e,t,l)){if(Mouse.Left){tm(e,t,l),th(tr.DRAGGING),e6.content=e6.content.drag(e6.content,t,l);return}void 0!==e.cursor?th(tr.HOVER,e.cursor(e,tr.HOVER)):e.dragOnly?th(tr.HOVER,"move"):th(tr.HOVER)}},camerapan(){let[e,t]=Mouse.position;if(e*=DPR,t*=DPR,e>=state.view.left&&e<=state.view.right&&t>=state.view.top&&t<=state.view.bottom){th(tr.BRUSH);return}}};let tn=!0;tr.VOIDING={cursor:"auto",mousemove(e){let t=e6.voidingStart,[l,i]=t,o=[e.clientX-l,e.clientY-i];Math.hypot(...o)>10&&(th(tr.FREE),tr.FREE.mousemove(e))},mouseup(t){let i=WORLD_SIZE;if(setWorldSize(0),tn)f(.5,.5);else{let o=state.brush.colour;state.brush.colour=111*i,f(.5,.5),state.brush.colour=o,state.worldBuilt=!1,e.paused=!1,l.style["background-color"]=Colour.Void}tn=!tn,setWorldSize(i),th(tr.FREE)}},tr.BRUSH={cursor:"crosshair",mousemove(e){let t=e.clientX/C,l=e.clientY/C,i=tu(t,l);if(void 0!==i){i.grabbable?void 0!==i.cursor?th(tr.HOVER,i.cursor(i,tr.HOVER)):i.dragOnly?th(tr.HOVER,"move"):th(tr.HOVER):th(tr.FREE);return}let o=e.clientX*DPR,a=e.clientY*DPR;(!(o>=state.view.left)||!(o<=state.view.right)||!(a>=state.view.top)||!(a<=state.view.bottom))&&th(tr.FREE)},mousedown(e){th(tr.BRUSHING)},middlemousedown(e){th(tr.PENCILLING)},atommove(e,t,l){tv(e,t,l)&&(e.grabbable?th(tr.HOVER):th(tr.FREE))},camerapan(){let[e,t]=Mouse.position;e*=DPR,t*=DPR,(!(e>=state.view.left)||!(e<=state.view.right)||!(t>=state.view.top)||!(t<=state.view.bottom))&&th(tr.FREE)}},tr.BRUSHING={cursor:"crosshair",mousemove(e){let t=e.clientX*DPR,l=e.clientY*DPR;(!(t>=state.view.left)||!(t<=state.view.right)||!(l>=state.view.top)||!(l<=state.view.bottom))&&th(tr.FREE)},mouseup(e){th(tr.BRUSH)},camerapan(){let[e,t]=Mouse.position;if(e*=DPR,t*=DPR,e>=state.view.left&&e<=state.view.right&&t>=state.view.top&&t<=state.view.bottom)return;let[l,i]=Mouse.position.map(e=>e/C),o=tu(l,i);if(void 0!==o){o.grabbable?void 0!==o.cursor?th(tr.HOVER,o.cursor(o,tr.HOVER)):o.dragOnly?th(tr.HOVER,"move"):th(tr.HOVER):th(tr.FREE);return}th(tr.FREE)}},tr.PENCILLING={cursor:"crosshair",mousemove:tr.BRUSHING.mousemove,middlemouseup:tr.BRUSHING.mouseup,camerapan:tr.BRUSHING.camerapan},tr.HOVER={cursor:"pointer",mousedown(e){let t=tu(e.clientX/C,e.clientY/C);void 0!==t&&t.grabbable&&(tm(t,e.clientX/C,e.clientY/C),t.dragOnly?(e6.pityStartX=e.clientX,e6.pityStartY=e.clientY,e6.pityStartT=Date.now(),e6.hasStartedDragging=!1,e6.touchButton=0,th(tr.TOUCHING,"move")):(e6.pityStartX=e.clientX,e6.pityStartY=e.clientY,e6.pityStartT=Date.now(),e6.hasStartedDragging=!1,e6.touchButton=0,th(tr.TOUCHING)))},mousemove(e){let t=e.clientX/C,l=e.clientY/C,i=tu(t,l);if(void 0!==i){i.grabbable?void 0!==i.cursor?th(tr.HOVER,i.cursor(i,tr.HOVER)):i.dragOnly?th(tr.HOVER,"move"):th(tr.HOVER):th(tr.FREE);return}let o=e.clientX,a=e.clientY;if(o>=state.view.left&&o<=state.view.right&&a>=state.view.top&&a<=state.view.bottom){th(tr.BRUSH);return}th(tr.FREE)},atommove(e,t,l){if(tv(e,t,l))return;let i=tu(t,l);if(void 0!==i)return;let[o,a]=Mouse.position;if(o*=DPR,a*=DPR,o>=state.view.left&&o<=state.view.right&&a>=state.view.top&&a<=state.view.bottom){th(tr.BRUSH);return}th(tr.FREE)},rightmousedown(e){let t=tu(e.clientX/C,e.clientY/C);void 0!==t&&t.grabbable&&(tm(t,e.clientX/C,e.clientY/C),t.dragOnly?(e6.pityStartX=e.clientX,e6.pityStartY=e.clientY,e6.pityStartT=Date.now(),e6.hasStartedDragging=!1,e6.touchButton=2,th(tr.TOUCHING,"move")):(e6.pityStartX=e.clientX,e6.pityStartY=e.clientY,e6.pityStartT=Date.now(),e6.hasStartedDragging=!1,e6.touchButton=2,th(tr.TOUCHING)))}};let td=(e,t)=>t?.6*e:e;tr.TOUCHING={cursor:"pointer",mousemove(e){if(0===e.movementX&&0===e.movementY||2===e6.touchButton&&!e6.content.rightDraggable)return;let t=Math.hypot(e.clientX-e6.pityStartX,e.clientY-e6.pityStartY),l=e.clientX-e6.pityStartX,i=e.clientY-e6.pityStartY;if(e6.content.dragLockX||(e6.content.x=(e6.pityStartX+td(l,e6.content.attached&&!e6.content.noDampen))/C*DPR+e6.offset.x),e6.content.dragLockY||(e6.content.y=(e6.pityStartY+td(i,e6.content.attached&&!e6.content.noDampen))/C*DPR+e6.offset.y),e6.content.x=clamp(e6.content.x,e6.content.minX,e6.content.maxX),e6.content.y=clamp(e6.content.y,e6.content.minY,e6.content.maxY),t<15)return;let o=Date.now()-e6.pityStartT;if(o<100){let a=Math.hypot(e6.velocity.x,e6.velocity.y);if(a<=10)return}e6.content.dragLockX||(e6.content.x=e6.pityStartX/C*DPR+e6.offset.x),e6.content.dragLockY||(e6.content.y=e6.pityStartY/C*DPR+e6.offset.y),e6.content.x=clamp(e6.content.x,e6.content.minX,e6.content.maxX),e6.content.y=clamp(e6.content.y,e6.content.minY,e6.content.maxY);let r=e.clientX/C,n=e.clientY/C;if(0===e6.touchButton&&e6.content.draggable){th(tr.DRAGGING);let d=e6.content.attached&&!e6.content.dragOnly&&!e6.content.noDampen;e6.content=e6.content.drag(e6.content,r,n),e6.content.dragLockX||(e6.content.x=(e6.pityStartX+td(l,d))/C+e6.offset.x),e6.content.dragLockY||(e6.content.y=(e6.pityStartY+td(i,d))/C+e6.offset.y),e6.content.x=clamp(e6.content.x,e6.content.minX,e6.content.maxX),e6.content.y=clamp(e6.content.y,e6.content.minY,e6.content.maxY),tr.DRAGGING.mousemove(e);return}if(2===e6.touchButton&&e6.content.rightDraggable){th(tr.DRAGGING);let h=e6.content.attached&&!e6.content.dragOnly&&!e6.content.noDampen;e6.content=e6.content.rightDrag(e6.content,r,n),e6.content.dragLockX||(e6.content.x=(e6.pityStartX+td(l,h))/C+e6.offset.x),e6.content.dragLockY||(e6.content.y=(e6.pityStartY+td(i,h))/C+e6.offset.y),e6.content.x=clamp(e6.content.x,e6.content.minX,e6.content.maxX),e6.content.y=clamp(e6.content.y,e6.content.minY,e6.content.maxY),tr.DRAGGING.mousemove(e);return}let s=tu(r,n);if(void 0!==s){s.grabbable?void 0!==s.cursor?th(tr.HOVER,s.cursor(s,tr.HOVER)):s.dragOnly?th(tr.HOVER,"move"):th(tr.HOVER):th(tr.FREE);return}let c=e.clientX*DPR,u=e.clientY*DPR;if(c>=state.view.left&&c<=state.view.right&&u>=state.view.top&&u<=state.view.bottom){th(tr.BRUSH);return}th(tr.FREE)},mouseup(e){if(0!==e6.touchButton)return;e6.clickContent.click(e6.clickContent),e6.clickContent.dx=0,e6.clickContent.dy=0,e6.clickContent=void 0,e6.content.attached&&(e6.content.x=e6.pityStartX/C*DPR+e6.offset.x,e6.content.y=e6.pityStartY/C*DPR+e6.offset.y),e6.content.dx=0,e6.content.dy=0,e6.content=void 0;let t=e.clientX/C,l=e.clientY/C,i=tu(t,l);void 0!==i?void 0!==i.cursor?th(tr.HOVER,i.cursor(i,tr.HOVER)):i.dragOnly?th(tr.HOVER,"move"):th(tr.HOVER):th(tr.FREE)},rightmouseup(e){if(2!==e6.touchButton)return;e6.clickContent.rightClick(e6.clickContent),e6.clickContent.dx=0,e6.clickContent.dy=0,e6.clickContent=void 0,e6.content.attached&&(e6.content.x=e6.pityStartX/C*DPR+e6.offset.x,e6.content.y=e6.pityStartY/C*DPR+e6.offset.y),e6.content.dx=0,e6.content.dy=0,e6.content=void 0;let t=e.clientX/C,l=e.clientY/C,i=tu(t,l);void 0!==i?void 0!==i.cursor?th(tr.HOVER,i.cursor(i,tr.HOVER)):i.dragOnly?th(tr.HOVER,"move"):th(tr.HOVER):th(tr.FREE)}},tr.DRAGGING={cursor:"move",mousemove(e){e6.hasStartedDragging||(e6.hasStartedDragging=!0,e6.content=e6.content.drag(e6.content,e.clientX/C*DPR,e.clientY/C*DPR));let t=e6.content.x,l=e6.content.y;e6.content.dragLockX||(e6.content.x=e.clientX/C*DPR+e6.offset.x),e6.content.dragLockY||(e6.content.y=e.clientY/C*DPR+e6.offset.y),e6.content.x=clamp(e6.content.x,e6.content.minX,e6.content.maxX),e6.content.y=clamp(e6.content.y,e6.content.minY,e6.content.maxY);let i=e6.content.x-t,o=e6.content.y-l;e6.content.move(e6.content,i,o)},mouseup(e){if(0!==e6.touchButton)return;e6.hasStartedDragging=!0,e6.content.dragLockX||(e6.content.dx=e6.velocity.x*HAND_RELEASE),e6.content.dragLockY||(e6.content.dy=e6.velocity.y*HAND_RELEASE),e6.content.drop(e6.content),void 0!==e6.content.highlightedAtom&&(e6.content.place(e6.content,e6.content.highlightedAtom),void 0!==e6.content.highlight&&(tb(e6.content,e6.content.highlight),e6.content.highlight=void 0)),e6.content=void 0;let t=e.clientX/C,l=e.clientY/C,i=tu(t,l);void 0!==i&&i.grabbable?void 0!==i.cursor?th(tr.HOVER,i.cursor(i,tr.HOVER)):i.dragOnly?th(tr.HOVER,"move"):th(tr.HOVER):th(tr.FREE)},rightmouseup(e){if(2!==e6.touchButton)return;e6.hasStartedDragging=!0,e6.content.dragLockX||(e6.content.dx=e6.velocity.x*HAND_RELEASE),e6.content.dragLockY||(e6.content.dy=e6.velocity.y*HAND_RELEASE),e6.content.drop(e6.content),void 0!==e6.content.highlightedAtom&&(e6.content.place(e6.content,e6.content.highlightedAtom),void 0!==e6.content.highlight&&(tb(e6.content,e6.content.highlight),e6.content.highlight=void 0)),e6.content=void 0;let t=e.clientX/C,l=e.clientY/C,i=tu(t,l);void 0!==i&&i.grabbable?void 0!==i.cursor?th(tr.HOVER,i.cursor(i,tr.HOVER)):i.dragOnly?th(tr.HOVER,"move"):th(tr.HOVER):th(tr.FREE)}};let th=(e,t=e.cursor)=>{void 0!==e6.content&&void 0!==e6.content.cursor&&(t=e6.content.cursor(e6.content,e)),e9.style.cursor=t,e6.state=e};on.mousemove(e=>e6.state.mousemove?e6.state.mousemove(e):void 0),on.mousedown(e=>{0===e.button&&e6.state.mousedown&&e6.state.mousedown(e),1===e.button&&e6.state.middlemousedown&&e6.state.middlemousedown(e),2===e.button&&e6.state.rightmousedown&&e6.state.rightmousedown(e)}),on.mouseup(e=>{0===e.button&&e6.state.mouseup&&e6.state.mouseup(e),1===e.button&&e6.state.middlemouseup&&e6.state.middlemouseup(e),2===e.button&&e6.state.rightmouseup&&e6.state.rightmouseup(e)}),e6.state=tr.FREE;let ts={x:0,y:0,grab:(e,t,l,i=e)=>i,touch:(e,t=e)=>t},tc=({grabbable:e=!0,draggable:t=!0,click:l=()=>{},rightClick:i=()=>{},drag:o=e=>e,rightDrag:a=e=>e,move:r=()=>{},drop:n=()=>{},draw:d=()=>{},update:h=()=>{},offscreen:s=()=>!1,overlaps:c=()=>!1,grab:u=e=>e,touch:g=e=>e,highlighter:$=!1,hover:p=()=>{},place:f=()=>{},x:v=0,y:m=0,dx:_=0,dy:w=0,maxX:b=1/0,minX:S=-1/0,maxY:R=1/0,minY:C=-1/0,size:T=40,colour:k=Colour.splash(999),children:E=[],parent:z=ts,width:O=T,height:D=T,construct:P=()=>{},hasInner:A=!0,...I}={},...B)=>{let L={highlighter:$,place:f,hover:p,hasInner:A,move:r,drop:n,maxX:b,minX:S,maxY:R,minY:C,update:h,construct:P,draggable:t,width:O,height:D,touch:g,parent:z,children:E,draw:d,grabbable:e,click:l,drag:o,overlaps:c,offscreen:s,grab:u,x:v,y:m,dx:_,dy:w,size:T,colour:k,rightClick:i,rightDrag:a,...I};return L.construct(L,...B),L},tu=(e,t)=>{e*=DPR,t*=DPR;for(let l=state.colourTode.atoms.length-1;l>=0;l--){let i=state.colourTode.atoms[l];if(i.justVisual)continue;let o=tv(i,e,t);if(void 0!==o)return o}},tg=e=>{for(let t of e.children)t.behindParent&&tg(t);for(let l of(e.behindChildren&&e.draw(e),e.children))l.behindParent||tg(l);e.behindChildren||e.draw(e)},t$=e=>{let t=state.colourTode.atoms.indexOf(e);state.colourTode.atoms.splice(t,1)},tp=e=>{state.colourTode.atoms.push(e)},tf=e=>{for(let t of e.children)if(!tf(t))return!1;return e.offscreen(e)},tv=(e,t,l)=>{if(!e.behindChildren&&e.overlaps(e,t,l))return e;for(let i=e.children.length-1;i>=0;i--){let o=e.children[i];if(o.behindParent)continue;let a=tv(o,t,l);if(a)return a}if(e.behindChildren&&e.overlaps(e,t,l))return e;for(let r=e.children.length-1;r>=0;r--){let n=e.children[r];if(!n.behindParent)continue;let d=tv(n,t,l);if(d)return d}},tm=(e,t,l)=>{let i=e,o=e.touch(e);if(o!==i){let a=o.touch(o,t,l,i);i=o,o=a}e6.clickContent=o;let r=e,n=e.grab(e,t,l);if(void 0===n)return;if(n!==r){let d=n.grab(n,t,l,r);r=n,n=d}e6.content=n;let{x:h,y:s}=tx(n,{forceAbsolute:!0});return e6.offset.x=h-t*DPR,e6.offset.y=s-l*DPR,n.dx=0,n.dy=0,e.stayAtBack?t_(n):ty(n),n},ty=e=>{if(e.parent===ts)t$(e),tp(e);else{let t=e.parent.children.indexOf(e);e.parent.children.splice(t,1),e.parent.children.push(e),e.parent.stayAtBack?t_(e.parent):ty(e.parent)}},t_=e=>{if(e.parent===ts){let t=state.colourTode.atoms.indexOf(e);state.colourTode.atoms.splice(t,1),state.colourTode.atoms.unshift(e)}else{let l=e.parent.children.indexOf(e);e.parent.children.splice(l,1),e.parent.children.unshift(e),e.parent.stayAtBack?t_(e.parent):ty(e.parent)}},tx=(e,{forceAbsolute:t=!1}={})=>{let{x:l,y:i}=e;if(t||void 0===e.parent||e.hasAbsolutePosition)return{x:l,y:i};let{x:o,y:a}=tx(e.parent);return{x:l+o,y:i+a}},tw=(e,t,{bottom:l=!1}={})=>{let i=tc(t);return l?e.children.unshift(i):e.children.push(i),i.parent=e,i},tb=(e,t,{quiet:l=!1}={})=>{let i=e.children.indexOf(t);if(-1===i){if(l)return;throw Error("Can't delete child of atom because I can't find it!")}e.children.splice(i,1),t.parent=ts},t0=(e,t)=>{if(void 0===t)throw Error("Can't give child because child is undefined");if(void 0===e)throw Error("Can't give child because parent is undefined");t$(t),t.stayAtBack||t.behindOtherChildren?e.children.unshift(t):e.children.push(t),t.parent=e},tS=(e,t)=>{if(e6.content===t){let{x:l,y:i}=tx(e);e6.offset.x+=l,e6.offset.y+=i}tb(e,t),tp(t)},tR=3;borderColours=PREBUILT_BORDER_COLOURS;let tC=borderColours.clone;tC[999]=Colour.splash(999);let tT={draw(e){let{x:t,y:l}=tx(e),i=Math.round(t),o=Math.round(l),a=Math.round(e.width),r=Math.round(e.height),n=Math.round(e.width/2);if(e.hasBorder){if(e.hasInner){let d=tR;void 0===e.borderColour?(eJ.fillStyle=Colour.splash(e.colour.splash),e.isTool?(eJ.fillStyle=Colour.splash(e.colour.splash),d*=1.5):e.width===e.height&&(d*=1.5)):eJ.fillStyle=e.borderColour,eJ.beginPath(),eJ.rect(i,o,a,r),void 0!==e.stamp&&eJ.arc(i+n,o+n,Math.round((ly.size-tX/2)/2),0,2*Math.PI),e.isGradient?eJ.putImageData(e.gradient,i*C,o*C):(eJ.fill("evenodd"),eJ.beginPath(),eJ.fillStyle=e.colour,eJ.rect(i+d,o+d,a-2*d,r-2*d),void 0!==e.stamp&&eJ.arc(i+n,o+n,Math.round((ly.size-tX/2)/2)+d,0,2*Math.PI),eJ.fill("evenodd"))}else void 0===e.borderColour?eJ.strokeStyle=borderColours[e.colour.splash]:eJ.strokeStyle=e.borderColour,i=Math.round(t+.5)-.5,o=Math.round(l+.5)-.5,eJ.lineWidth=tR,eJ.strokeRect(i,o,a,r)}else eJ.fillStyle=e.colour,eJ.fillRect(i,o,a,r)},offscreen(e){let{x:t,y:i}=tx(e),o=t+e.width,a=i+e.height;return!!(o<0)||!!(a<0)||!!(t>l.width)||!!(i>l.height)},overlaps(e,t,l){let{x:i,y:o}=tx(e),a=tR;(e.isTool||e.isSquare||e.isTallRectangle)&&(a*=1.5);let r=i+e.width,n=o+e.height;return!(t<i)&&!(l<o)&&!(t>r)&&!(l>n)}},tk={draw(e){let{x:t,y:l}=tx(e),i=t+e.width/2,o=l+e.height/2,a=e.width/2;if(e.hasBorder){e.isTool&&(e.borderColour=tC[e.colour.splash]),eJ.fillStyle=void 0!==e.borderColour?e.borderColour:Colour.Void,eJ.beginPath(),eJ.arc(i,o,a,0,2*Math.PI),eJ.fill();let r=void 0!==e.borderScale?e.borderScale:1;a=e.width/2-1.5*tR*r}eJ.fillStyle=e.colour,eJ.beginPath(),eJ.arc(i,o,a,0,2*Math.PI),eJ.fill()},offscreen:tT.offscreen,overlaps:tT.overlaps},tE=(e,[t,l],i=!1)=>{for(let o of e.cellAtoms){i&&(o=o.slot);let{x:a,y:r}=tx(o);if(a===t&&r===l)return!0}return!1},tz=(e,[t,l],i=!1)=>{for(let o of e.cellAtoms){i&&(o=o.slot);let{x:a,y:r}=tx(o);if(a===t&&r===l&&(o.isLeftSlot||o.isSlot))return!0}return!1},tO=e=>{if("number"==typeof e)state.brush.colour=e,squareTool.toolbarNeedsColourUpdate=!0,squareTool.value=makeArrayFromSplash(e);else{let t=makeDiagramCell({content:e});state.brush.colour=makeDiagram({left:[t]}),squareTool.value=t.content,squareTool.toolbarNeedsColourUpdate=!0}},tD={isSquare:!0,hasBorder:!0,draw(e){!e.value.isDiagram&&tT.draw(e)},overlaps:tT.overlaps,offscreen:tT.offscreen,touch:e=>(tO(e.value),e),click(e){e.joins.length>0?e.parent!==ts&&e.parent.isPaddle||(e.joinExpanded?e.joinUnepxand(e):e.joinExpand(e)):e.value.isDiagram||(e.expanded?e.unexpand(e):e.parent!==ts&&e.parent.isPaddle||e.expand(e)),tO(e.value)},expand(e){e.expanded=!0,e.createPicker(e),e.value.channels.some(e=>void 0===e)&&lU("triangle")},unexpand(e){e.expanded=!1,e.redExpanded=e.red&&e.red.expanded,e.greenExpanded=e.green&&e.green.expanded,e.blueExpanded=e.blue&&e.blue.expanded,e.deletePicker(e)},createPicker(e){let t=tw(e,lk);t.width+=tX,e.pickerHandle=t,e.pickerHandle.behindParent=!0;let l=tw(e,t8);if(e.pickerPad=l,void 0!==e.value.channels[2]){if(void 0===e.value.channels[2].variable){let i=tw(e,tW);i.channelSlot="blue",i.x+=tH+3*(tD.size+tH),i.value=e.value.channels[2],i.needsColoursUpdate=!0,e.blue=i,i.deletedOptions=e.deletedBlueOptions,e.blueExpanded&&e.blue.click(e.blue),e.blue.attached=!0}else{let o=e.variableAtoms[2];o.behindOtherChildren=!1,tp(o),t0(e,o),o.variable="blue",o.x=(tH+tD.size)*3+(tD.size+tH)/2-o.width/3,o.y=e.height/2-o.height/2,o.attached=!0,e.blue=o}}if(void 0!==e.value.channels[1]){if(void 0===e.value.channels[1].variable){let a=tw(e,tW);a.channelSlot="green",a.x+=tH+2*(tD.size+tH),a.value=e.value.channels[1],a.needsColoursUpdate=!0,e.green=a,a.deletedOptions=e.deletedGreenOptions,e.greenExpanded&&e.green.click(e.green),e.green.attached=!0}else{let r=e.variableAtoms[1];r.behindOtherChildren=!1,tp(r),t0(e,r),r.variable="green",r.x=(tH+tD.size)*2+(tD.size+tH)/2-r.width/3,r.y=e.height/2-r.height/2,r.attached=!0,e.green=r}}if(void 0!==e.value.channels[0]){if(void 0===e.value.channels[0].variable){let n=tw(e,tW);n.channelSlot="red",n.x+=tH+tD.size+tH,n.value=e.value.channels[0],n.needsColoursUpdate=!0,e.red=n,n.deletedOptions=e.deletedRedOptions,e.redExpanded&&e.red.click(e.red),e.red.attached=!0}else{let d=e.variableAtoms[0];d.behindOtherChildren=!1,tp(d),t0(e,d),d.x=tH+tD.size+(tD.size+tH)/2-d.width/3,d.y=e.height/2-d.height/2,d.attached=!0,e.red=d}}},deletePicker(e){tb(e,e.pickerPad),tb(e,e.pickerHandle),e.red&&(e.deletedRedOptions=e.red.options,tb(e,e.red)),e.green&&(e.deletedGreenOptions=e.green.options,tb(e,e.green)),e.blue&&(e.deletedBlueOptions=e.blue.options,tb(e,e.blue))},receiveNumber(e,t,l=t.channel,{expanded:i,numberAtom:o}={}){if(e.redExpanded=e.red&&e.red.expanded,e.greenExpanded=e.green&&e.green.expanded,e.blueExpanded=e.blue&&e.blue.expanded,void 0===e.variableAtoms&&(e.variableAtoms=[void 0,void 0,void 0]),void 0!==t&&void 0!==t.variable?e.variableAtoms[l]=o:e.variableAtoms[l]=void 0,void 0!==i){let a=tj[l];e[`${a}Expanded`]=i}if(e.value.channels[l]=t,e.deletePicker(e),e.createPicker(e),e.needsColoursUpdate=!0,e.colourTicker=1/0,e.parent!==ts){let r=e.parent;lg(r)}let n=makeDiagramCell({content:e.value});state.brush.colour=makeDiagram({left:[n]}),squareTool.toolbarNeedsColourUpdate=!0,l7.toolbarNeedsColourUpdate=!0,lY.toolbarNeedsColourUpdate=!0,l3.toolbarNeedsColourUpdate=!0},construct(e){e.needsColoursUpdate=!0,"number"==typeof state.brush.colour?e.value=makeArrayFromSplash(state.brush.colour):e.value=Q(state.brush.colour.left[0].content),e.colourId=0,e.dcolourId=1,e.colourTicker=1/0,e.joins=[],e.joinColourIds=[],e.variableAtoms=[],e.gradient=new ImageData(e.width*C,e.height*C),e.headGradient=new ImageData(e.width*C,e.height*C)},updateGradient(e){let t=Q(e.value);if(t.joins=[],e.colours=M(t),e.isGradient=!0,e.joins.length>0&&!e.joinExpanded){let l=[];for(let i of e.joins)i.updateGradient(i),l.push(i.gradient);e.headGradient=tL({colours:e.colours,width:e.width*C,height:e.height*C,stamp:e.value.stamp,gradient:e.headGradient});let o=[e.headGradient,...l];e.gradient=tB({gradients:o,width:e.width*C,height:e.height*C,stamp:e.value.stamp,mergedGradient:e.gradient})}else e.gradient=tL({colours:e.colours,width:e.width*C,height:e.height*C,gradient:e.gradient,stamp:e.value.stamp})},update(e){if(e.value.isDiagram){if(void 0===e.multiAtoms||0===e.multiAtoms.length){e.multiAtoms=[];let t=e.value,[l,i]=eo(t),o=e.width/l,a=e.height/i;for(let r of t.left){let n=tw(e,tD);n.x=r.x*o,n.y=r.y*a,n.width=r.width*o,n.height=r.height*a,n.value=r.content,e.multiAtoms.push(n)}}}else e.needsColoursUpdate&&(e.updateGradient(e),e.needsColoursUpdate=!1);let{x:d,y:h}=tx(e);if(e.highlightedAtom=void 0,e6.content===e&&e6.state===tr.DRAGGING){let s=d,c=h,u=d+e.width,g=h+e.height;if(void 0!==e.highlight&&(tb(e,e.highlight),e.highlight=void 0),void 0===e.highlightedAtom){let $=lp();for(let p of $){if(p===e||!p.isSquare)continue;p.joins.length>0&&p.joinExpanded&&(p=p.pickerPad);let{x:f,y:v}=tx(p),m=f,_=f+p.width,w=v,b=v+p.height;if(!(s>_)&&!(u<m)&&!(g<w)&&!(c>b)){if(p.isPicker)e.highlightedAtom=p.parent;else{if(p.parent!==ts)continue;e.highlightedAtom=p}e.highlight=tw(e,lS,{bottom:!0}),e.highlight.hasBorder=!0,e.highlight.hasInner=!1,e.highlight.width=p.width,e.highlight.height=p.height,e.highlight.x=f,e.highlight.y=v;break}}}if(void 0===e.highlightedAtom)for(let S of paddles){if(!S.expanded)continue;let{x:R,y:C}=tx(S),T=R,k=R+S.width,E=C,z=C+S.height;if(!(s>k)&&!(u<T)&&!(c>z)&&!(g<E)){if(0===S.cellAtoms.length){let{x:O,y:D}=tx(S.dummyLeft),{x:P,y:A}=tx(S.dummyRight);void 0===S.rightTriangle?(e.highlight=tw(e,lS,{bottom:!0}),e.highlight.hasBorder=!0,e.highlight.colour=Colour.Grey,e.highlight.x=O,e.highlight.y=D,e.highlight.width=S.dummyLeft.width,e.highlight.height=S.dummyLeft.height,e.highlightedSide="left",e.highlightedAtom=S):s>T+S.rightTriangle.x?(e.highlight=tw(e,lS,{bottom:!0}),e.highlight.hasBorder=!0,e.highlight.colour=Colour.Grey,e.highlight.x=P,e.highlight.y=A,e.highlight.width=S.dummyRight.width,e.highlight.height=S.dummyRight.height,e.highlightedSide="right",e.highlightedAtom=S):(e.highlight=tw(e,lS,{bottom:!0}),e.highlight.hasBorder=!0,e.highlight.colour=Colour.Grey,e.highlight.x=O,e.highlight.y=D,e.highlight.width=S.dummyLeft.width,e.highlight.height=S.dummyLeft.height,e.highlightedSide="left",e.highlightedAtom=S);break}if(void 0!==S.rightTriangle&&s>T+S.rightTriangle.x){let I=1/0,B,L;for(let G of S.cellAtoms){let N=G.slot,{x:U,y:Y}=tx(N),X=U,H=U+N.width,V=Y,j=Y+N.height,W=[X,V],q=[X-N.width,V],Z=[X,V-N.height],F=[H,V],M=[X,j],K=Math.hypot(d-W[0],h-W[1]);void 0===G.slotted&&tz(S,W,!0)&&K<I&&(I=K,L=N,B="slot");let J=Math.hypot(d-q[0],h-q[1]);!tE(S,q,!0)&&J<I&&(I=J,L=N,B="left");let Q=Math.hypot(d-Z[0],h-Z[1]);!tE(S,Z,!0)&&Q<I&&(I=Q,L=N,B="above");let ee=Math.hypot(d-F[0],h-F[1]);!tE(S,F,!0)&&ee<I&&(I=ee,L=N,B="right");let et=Math.hypot(d-M[0],h-M[1]);!tE(S,M,!0)&&et<I&&(I=et,L=N,B="below")}let{x:el,y:ei}=tx(L);if(e.highlight=tw(e,lS,{bottom:!0}),"left"===B||"right"===B?(e.highlight.width=l0,e.highlight.height=L.height):("above"===B||"below"===B)&&(e.highlight.width=L.width,e.highlight.height=l0),"left"===B?(e.highlight.x=el-l0/2,e.highlight.y=ei):"right"===B?(e.highlight.x=el-l0/2+L.width,e.highlight.y=ei):"above"===B?(e.highlight.x=el,e.highlight.y=ei-l0/2):"below"===B&&(e.highlight.x=el,e.highlight.y=ei-l0/2+L.height),"slot"===B){e.highlight.width=tD.size,e.highlight.height=tD.size;let{x:ea,y:er}=tx(L);e.highlight.x=ea,e.highlight.y=er,e.highlight.hasBorder=!0,e.highlight.colour=Colour.Grey}e.highlightedAtom=L,e.highlightedSide=B;break}else{let en=1/0,ed,eh;for(let es of S.cellAtoms){let{x:ec,y:eu}=tx(es),eg=ec,e$=ec+es.width,ep=eu,ef=eu+es.height,ev=[eg,ep],em=[eg-es.width,ep],ey=[eg,ep-es.height],e_=[e$,ep],ex=[eg,ef],ew=Math.hypot(d-ev[0],h-ev[1]);tz(S,ev)&&ew<en&&(en=ew,eh=es,ed="slot");let eb=Math.hypot(d-em[0],h-em[1]);!tE(S,em)&&eb<en&&(en=eb,eh=es,ed="left");let e0=Math.hypot(d-ey[0],h-ey[1]);!tE(S,ey)&&e0<en&&(en=e0,eh=es,ed="above");let eS=Math.hypot(d-e_[0],h-e_[1]);!tE(S,e_)&&eS<en&&(en=eS,eh=es,ed="right");let eR=Math.hypot(d-ex[0],h-ex[1]);!tE(S,ex)&&eR<en&&(en=eR,eh=es,ed="below")}let{x:eC,y:eT}=tx(eh);if(e.highlight=tw(e,lS,{bottom:!0}),"left"===ed||"right"===ed?(e.highlight.width=l0,e.highlight.height=eh.height):("above"===ed||"below"===ed)&&(e.highlight.width=eh.width,e.highlight.height=l0),"left"===ed?(e.highlight.x=eC-l0/2,e.highlight.y=eT):"right"===ed?(e.highlight.x=eC-l0/2+eh.width,e.highlight.y=eT):"above"===ed?(e.highlight.x=eC,e.highlight.y=eT-l0/2):"below"===ed&&(e.highlight.x=eC,e.highlight.y=eT-l0/2+eh.height),"slot"===ed){e.highlight.width=tD.size,e.highlight.height=tD.size;let{x:ek,y:eE}=tx(eh);e.highlight.x=ek,e.highlight.y=eE,e.highlight.hasBorder=!0,e.highlight.colour=Colour.Grey}e.highlightedAtom=eh,e.highlightedSide=ed;break}}}}void 0===e.highlightedAtom&&void 0!==e.highlight&&(tb(e,e.highlight),e.highlight=void 0)},drop(e){if(void 0!==e.highlight){if(e.highlightedAtom.isPaddle){let t=e.highlightedAtom;if(e.attached=!0,"right"===e.highlightedSide){let l=tw(t,la,{bottom:!0});l.x=li.width/2-e.width/2,l.y=li.height/2-e.height/2,l.isLeftSlot=!0,l.isSlot=!1,t.cellAtoms.push(l),l.slotted=e,e.cellAtom=l,e.x=e.highlightedAtom.x,e.y=e.highlightedAtom.y,e.slottee=!0,t0(t,e)}else t.cellAtoms.push(e),e.x=e.highlightedAtom.x,e.y=e.highlightedAtom.y,e.dx=0,e.dy=0,t0(t,e);ln(t)}else if(e.highlightedAtom.isSlot&&"slot"===e.highlightedSide){let i=e.highlightedAtom,o=i.parent;e.attached=!0,t0(o,e),e.x=i.x,e.y=i.y,e.dx=0,e.dy=0,i.cellAtom.slotted=e,e.cellAtom=i.cellAtom,e.slottee=!0,ln(i.parent)}else if(e.highlightedAtom.isLeftSlot&&"slot"===e.highlightedSide){let a=e.highlightedAtom,r=a.parent,n=r.cellAtoms.indexOf(a);r.cellAtoms.splice(n,1),e.x=a.x,e.y=a.y,e.attached=!0,r.cellAtoms.push(e),e.slotted=a.slotted,e.slot=a.slot,void 0!==a.slotted&&(a.slotted.cellAtom=e),t0(r,e),lg(r),tb(r,a)}else if(e.highlightedAtom.isSlot&&"slot"!==e.highlightedSide){let d=e.highlightedAtom,h=d.parent;e.attached=!0,t0(h,e);let s=tw(h,la,{bottom:!0});s.isLeftSlot=!0,h.cellAtoms.push(s),s.isSlot=!1,s.slotted=e,s.slotted.cellAtom=s,s.slot=d,e.slotted=void 0,e.expanded&&e.unexpand(e),"left"===e.highlightedSide?(e.x=d.x-e.width,e.y=d.y):"right"===e.highlightedSide?(e.x=d.x+d.width,e.y=d.y):"above"===e.highlightedSide?(e.x=d.x,e.y=d.y-e.height):"below"===e.highlightedSide&&(e.x=d.x,e.y=d.y+d.height),s.x=e.x-h.offset,s.y=e.y,e.cellAtom=s,e.slottee=!0,e.dx=0,e.dy=0,ln(h)}else if((e.highlightedAtom.isLeftSlot||e.highlightedAtom.isSquare)&&e.highlightedAtom.parent.isPaddle){let c=e.highlightedAtom,u=c.parent;e.attached=!0,t0(u,e),u.cellAtoms.push(e),e.expanded&&e.unexpand(e),"left"===e.highlightedSide?(e.x=c.x-e.width,e.y=c.y):"right"===e.highlightedSide?(e.x=c.x+c.width,e.y=c.y):"above"===e.highlightedSide?(e.x=c.x,e.y=c.y-e.height):"below"===e.highlightedSide&&(e.x=c.x,e.y=c.y+c.height),void 0!==u.rightTriangle&&void 0!==e.slotted&&(tp(e.slotted),t0(u,e.slotted)),e.dx=0,e.dy=0,ln(u)}else{let g=e.highlightedAtom,$=e;g.expanded&&g.unexpand(g),$.expanded&&$.unexpand($),g.joinExpanded&&g.joinUnepxand(g),g.joins.push($),t$($),g.joinExpand(g),g.value.joins.push($.value),g.needsColoursUpdate=!0,g.colourTicker=1/0,tO(g.value)}e.expanded&&e.unexpand(e),e.joinExpanded&&e.joinUnepxand(e)}},joinExpand(e){e.joinExpanded=!0;let t=tw(e,t8);e.pickerPad=t,t.width=e.width+2*tX,t.x=-tX,t.height=e.joins.length*(e.height+tX)+tX,t.y=e.height+tX,t.touch=e=>e,t.grab=e=>e.parent,t.dragOnly=!0;let l=tw(e,t8);e.pickerHandle=l,l.width=lk.height,l.x=e.width/2-l.width/2,l.height=lk.width,l.y=e.height,l.touch=e=>e,l.grab=e=>e.parent,l.dragOnly=!0;for(let i=0;i<e.joins.length;i++){let o=e.joins[i];tp(o),t0(e,o),o.x=0,o.y=(i+1)*(e.height+tX)+tX,o.dx=0,o.dy=0,o.isJoiner=!0,o.touch=e=>e.parent}if(e.needsColoursUpdate=!0,e.colourTicker=1/0,void 0!==e.multiAtoms)for(let a of e.multiAtoms)ty(a);e.attached=!1},joinUnepxand(e){e.joinExpanded=!1,tb(e,e.pickerPad),tb(e,e.pickerHandle);for(let t=0;t<e.joins.length;t++){let l=e.joins[t];tb(e,l)}e.needsColoursUpdate=!0,e.colourTicker=1/0},clone(e){let t=lI(e.value),{x:l,y:i}=tx(e);return t.x=l,t.y=i,t},rightDraggable:!0,rightDrag(e){let t=e.clone(e);return e6.offset.x-=e.x-t.x,e6.offset.y-=e.y-t.y,tp(t),tO(t.value),t},drag(e){if(e.joins.length>0&&e.joinExpanded)return e;if(e.isJoiner){let t=e.parent.joins.indexOf(e);e.parent.joins.splice(t,1),e.parent.value.joins.splice(t,1),e.parent.joinUnepxand(e.parent),e.parent.joins.length>0&&e.parent.joinExpand(e.parent),tS(e.parent,e),e.isJoiner=!1,e.touch=tD.touch}if(e.attached){let l=e.parent;if(e.slottee){if(e.attached=!1,e.slottee=!1,tS(l,e),e.cellAtom.slotted=void 0,e.cellAtom.isLeftSlot){tb(l,e.cellAtom);let i=l.cellAtoms.indexOf(e.cellAtom);l.cellAtoms.splice(i,1)}return e.cellAtom=void 0,ln(l),e}let{x:o,y:a}=e;e.attached=!1,tS(l,e);let r=l.cellAtoms.indexOf(e);if(l.cellAtoms.splice(r,1),e.slot=void 0,void 0!==l.rightTriangle&&void 0!==e.slotted){let n=tw(l,la,{bottom:!0});n.x=o,n.y=a,n.isLeftSlot=!0,l.cellAtoms.push(n),n.isSlot=!1,n.slotted=e.slotted,n.slotted.cellAtom=n,e.slotted=void 0}ln(l)}return e},size:40,expanded:!1},tP=(e,t)=>{let l=.5,i=.5;return[[1,0],[1,.5],[1,1],[.5,0],[.5,.5],[.5,1],[0,0],[0,.5],[0,1],]},tA=(e,t,l)=>{let i=[];for(let[o,a]of l){let r=[o-e,a-t],n=Math.hypot(...r);i.push(n)}return i},tI=e=>{let t=[];for(let l of e)t.push(l**2);return t},tB=({gradients:e,width:t,height:l,mergedGradient:i=new ImageData(t,l),stamp:o})=>{[t,l]=[t,l].map(e=>Math.round(e));let a=t*l*4;i.data.length!==a&&(i=new ImageData(t,l));let r=e.length,n=2*Math.PI/r,d=-n/2-Math.PI/2;2===r&&(d-=Math.PI/4);let h=e.map((e,t)=>t*n+n),s=0;for(let c=0;c<l;c++)for(let u=0;u<t;u++){let g=u-t/2,$=c-l/2,p=Math.atan2($,g)-d;for(;p<0;)p+=2*Math.PI;for(;p>2*Math.PI;)p-=2*Math.PI;let f=0,v=!1,m=0;for(;p>h[f];)if(++f>=e.length){f=0;break}let _=h[f]-p,w=f-1<0?h.length-1:f-1,b=h[w],S=b-p,R=f+1>=h.length?0:f+1,C;.05>Math.abs(S)?(v=!0,m=-S/.05/2+.5,C=w):.05>Math.abs(_)?(v=!0,m=_/.05/2+.5,C=R):p<.05&&(v=!0,m=p/.05/2+.5,C=w),v?(i.data[s]=e[f].data[s]*m+e[C].data[s]*(1-m),i.data[s+1]=e[f].data[s+1]*m+e[C].data[s+1]*(1-m),i.data[s+2]=e[f].data[s+2]*m+e[C].data[s+2]*(1-m),i.data[s+3]=e[f].data[s+3]*m+e[C].data[s+3]*(1-m)):(i.data[s]=e[f].data[s],i.data[s+1]=e[f].data[s+1],i.data[s+2]=e[f].data[s+2],i.data[s+3]=e[f].data[s+3]),s+=4}return i},tL=({colours:e,width:t,height:l,gradient:i=new ImageData(t,l),stamp:o})=>{[t,l]=[t,l].map(e=>Math.round(e));let a=t*l*4;i.data.length!==a&&(i=new ImageData(t,l));let r=1/0,n=-1/0,d=1/0,h=-1/0,s=1/0,c=-1/0;for(let u of e){let[g,$,p]=getRGB(u);g<r&&(r=g),g>n&&(n=g),$<d&&(d=$),$>h&&(h=$),p<s&&(s=p),p>c&&(c=p)}let f=(e,t,l)=>Colour.splash((1===e?n:r)+(1===t?h:d)+(1===l?c:s)),v=[f(0,0,1),f(0,0,1),f(0,0,1),f(0,1,1),f(1,0,0),f(1,0,0),f(0,1,0),f(0,1,0),f(1,0,0)],m=tP(t,l),_=0;for(let w=0;w<l;w++)for(let b=0;b<t;b++){let S=tA(b/t,w/l,m),R=tI(S),C=[0,0,0],T=R.reduce((e,t)=>e+t);for(let k=0;k<9;k++){let E=R[k],z=v[k];[0,1,2].forEach(e=>C[e]+=E*z[e])}let O=C.map(e=>e/T);if("circle"===o&&b>=t/4&&b<3*t/4&&w>=l/4&&w<3*l/4?i.data[_+3]=0:(i.data[_]=O[0],i.data[_+1]=O[1],i.data[_+2]=O[2],i.data[_+3]=255),(_+=4)>=i.data.length)break}return i},tG={size:tD.size,width:tD.size*Math.sqrt(3)/2,draw(e){let{x:t,y:l}=tx(e),i=e.size;e.isTool&&(i-=2.5*tR),e.isTool||(i-=2);let o=i,a=i*Math.sqrt(3)/2,r=t,n=l+1;e.isTool&&(n+=1.25*tR);let d=n+o,h=n+o/2;eJ.fillStyle=e.colour;let s=new Path2D;s.moveTo(r,n),s.lineTo(r+a,h),s.lineTo(r,d),s.closePath(),eJ.fillStyle=e.colour,eJ.fill(s),e.hasBorder&&(eJ.lineWidth=1.5*tR,eJ.strokeStyle=e.borderColour,e.isTool&&(eJ.strokeStyle=tC[e.colour.splash]),eJ.stroke(s))},overlaps(e,t,l){let{x:i,y:o}=tx(e),a=e.size,r=e.size*Math.sqrt(3)/2,n=i,d=o;return!(t<n)&&!(l<d)&&!(t>n+r)&&!(l>d+a)},offscreen(e){let{x:t,y:i}=tx(e),o=e.size,a=e.size*Math.sqrt(3)/2,r=t,n=i;return!!(r+a<0)||!!(n+o<0)||!!(r>l.width)||!!(n>l.height)}},tN={size:tD.size,draw(e){let{x:t,y:l}=tx(e),i=e.size,o=e.size*Math.sqrt(3)/2,a=e.size-o,r=t,n=l+a/2,d=n+o;eJ.fillStyle=e.colour;let h=new Path2D;h.moveTo(r,d),h.lineTo(r+i/2,n),h.lineTo(r+i,d),h.closePath(),eJ.fillStyle=e.colour,eJ.fill(h),e.hasBorder&&(eJ.lineWidth=1.5*tR,eJ.strokeStyle=e.borderColour,eJ.stroke(h))},overlaps(e,t,l){let{x:i,y:o}=tx(e),a=e.size,r=e.size*Math.sqrt(3)/2,n=i,d=o;return!(t<n)&&!(l<d)&&!(t>n+a)&&!(l>d+r)},offscreen(e){let{x:t,y:i}=tx(e),o=e.size,a=e.size*Math.sqrt(3)/2,r=t,n=i;return!!(r+o<0)||!!(n+a<0)||!!(r>l.width)||!!(n>l.height)}},tU={size:tD.size,draw(e){let{x:t,y:l}=tx(e),i=e.size,o=e.size*Math.sqrt(3)/2,a=e.size-o,r=t,n=l+a/2;eJ.fillStyle=e.colour;let d=new Path2D;d.moveTo(r,n),d.lineTo(r+i/2,n+o),d.lineTo(r+i,n),d.closePath(),eJ.fillStyle=e.colour,eJ.fill(d),e.hasBorder&&(eJ.lineWidth=1.5*tR,eJ.strokeStyle=e.borderColour,eJ.stroke(d))},overlaps(e,t,l){let{x:i,y:o}=tx(e),a=e.size,r=e.size*Math.sqrt(3)/2,n=i,d=o;return!(t<n)&&!(l<d)&&!(t>n+a)&&!(l>d+r)},offscreen(e){let{x:t,y:i}=tx(e),o=e.size,a=e.size*Math.sqrt(3)/2,r=t,n=i;return!!(r+o<0)||!!(n+a<0)||!!(r>l.width)||!!(n>l.height)}},t7={size:tD.size,width:tD.size*Math.sqrt(3)/2,draw(e){let{x:t,y:l}=tx(e),i=e.size;e.isTool&&(i-=2.5*tR),e.isTool||(i-=2);let o=i,a=i*Math.sqrt(3)/2,r=t,n=r+a,d=l+1;e.isTool&&(d+=1.25*tR);let h=d+o,s=d+o/2;eJ.fillStyle=e.colour;let c=new Path2D;c.moveTo(n,d),c.lineTo(r,s),c.lineTo(n,h),c.closePath(),eJ.fillStyle=e.colour,eJ.fill(c),e.hasBorder&&(eJ.lineWidth=1.5*tR,eJ.strokeStyle=e.borderColour,e.isTool&&(eJ.strokeStyle=tC[e.colour.splash]),eJ.stroke(c))},overlaps(e,t,l){let{x:i,y:o}=tx(e),a=e.size,r=e.size*Math.sqrt(3)/2,n=i,d=o;return!(t<n)&&!(l<d)&&!(t>n+r)&&!(l>d+a)},offscreen(e){let{x:t,y:i}=tx(e),o=e.size,a=e.size*Math.sqrt(3)/2,r=t,n=i;return!!(r+a<0)||!!(n+o<0)||!!(r>l.width)||!!(n>l.height)}},tY={behindOtherChildren:!0,expanded:!1,draw(e){"right"===e.direction?tG.draw(e):"down"===e.direction?tU.draw(e):"up"===e.direction?tN.draw(e):"left"===e.direction?t7.draw(e):tG.draw(e)},colour:Colour.splash(999),overlaps:tG.overlaps,offscreen:tG.offscreen,size:tD.size,width:tG.width,direction:"right",click(e){if(e.parent.isPaddle){e.parent.pinhole.locked=!e.parent.pinhole.locked,lg(e.parent);return}e.expanded?e.unexpand(e):e.expand(e)},expand(e){e.pad=tw(e,lR),e.handle=tw(e,lC),e.expanded=!0,e.upPick=tw(e,lz),e.downPick=tw(e,lO),"up"===e.direction&&(e.upPick.value=!0),"down"===e.direction&&(e.downPick.value=!0)},unexpand(e){tb(e,e.pad),tb(e,e.handle),tb(e,e.upPick),tb(e,e.downPick),e.expanded=!1},highlighter:!0,hover(e){if(e.highlightedSlot=void 0,"right"===e.direction){let{x:t,y:l}=tx(e),i=t,o=l,a=t+e.width,r=l+e.height;for(let n of paddles){if(!n.expanded||n.pinhole.locked||void 0!==n.rightTriangle)continue;let{x:d,y:h}=tx(n),s=d,c=d+n.width,u=h,g=h+n.height;if(!(i>c)&&!(a<s)&&!(o>g)&&!(r<u))return n}}{let{x:$,y:p}=tx(e),f=$,v=p,m=$+e.width,_=p+e.height,w=lp();for(let b of w){if(!b.isSquare)continue;let{x:S,y:R}=tx(b),C=S,T=S+b.width,k=R,E=R+b.height;if(!(f>T)&&!(m<C)&&!(v>E)&&!(_<k))return b}let z=1/0,O,D,P=lp();for(let A of P){if(A===e||!A.isSquare||!A.expanded)continue;let{x:I,y:B}=tx(A.pickerPad),L=I,G=I+A.pickerPad.width,N=B,U=B+A.pickerPad.height;if(f>G||m<L||_<N||v>U)continue;let Y=["red","green","blue"].filter(e=>void 0===A[e]);if(0===Y.length)continue;let{x:X,y:H}=tx(A);for(let V of Y){let j=tV[V],W=X+A.size+2*tX+j*(tD.size+tH),q=H+tX,Z=Math.hypot($-W,p-q);Z<z&&(z=Z,D=V,O=A)}if(void 0!==O){let{x:F,y:M}=tx(O),K=tV[D];void 0!==e.highlight&&(tb(e,e.highlight),e.highlight=void 0),e.highlight=tw(e,lS,{bottom:!0}),e.highlight.hasBorder=!0,e.highlight.x=F+O.size+tX+K*(tX+O.size),e.highlight.y=M,e.highlight.width=2*tX+O.size,e.highlightedAtom=O,e.highlightedSlot=D}}return O}},updateValue(e){"up"===e.direction||"down"===e.direction?e.variable=e.highlightedSlot:"left"===e.direction?"red"===e.highlightedSlot?e.variable="blue":"green"===e.highlightedSlot?e.variable="red":"blue"===e.highlightedSlot&&(e.variable="green"):"right"===e.direction&&("red"===e.highlightedSlot?e.variable="green":"green"===e.highlightedSlot?e.variable="blue":"blue"===e.highlightedSlot&&(e.variable="red"));let t="up"===e.direction?j(1):void 0,l="down"===e.direction?j(1):void 0,i=X({channel:e.channelId,variable:e.variable,add:t,subtract:l});e.value=i},place(e,t){if(t.isSquare&&void 0!==e.highlightedSlot){e.channelId=tV[e.highlightedSlot],e.updateValue(e);let l=t;l.receiveNumber(l,e.value,e.channelId,{expanded:e.expanded,numberAtom:e}),t$(e),e.dx=0,e.dy=0;return}if(t.isSquare){let i=t;void 0===i.stamp?(i.stamp="circle",i.value.stamp="circle",i.needsColoursUpdate=!0):(i.stamp=void 0,i.value.stamp=void 0,i.needsColoursUpdate=!0);let o=makeDiagramCell({content:i.value});state.brush.colour=makeDiagram({left:[o]}),squareTool.toolbarNeedsColourUpdate=!0,lY.toolbarNeedsColourUpdate=!0,l7.toolbarNeedsColourUpdate=!0,l3.toolbarNeedsColourUpdate=!0,i.parent.isPaddle&&lg(i.parent);return}if(t.isPaddle){let a=t;for(let r of(t0(a,e),a.rightTriangle=e,e.x=li.width/2-e.width/2,e.y=li.height/2-e.height/2,e.dx=0,e.dy=0,e.hasBorder=!1,a.pinhole.locked=e.colour===Colour.splash(999),a.cellAtoms))void 0!==r.slotted&&(tp(r.slotted),t0(a,r.slotted));ln(a),e.expanded&&e.unexpand(e),e.attached=!0,lU("circle")}},rightDraggable:!0,rightDrag(e){let t=tc(tY);t.direction=e.direction;let{x:l,y:i}=tx(e);return e6.offset.x-=e.x-l,e6.offset.y-=e.y-i,t.x=l,t.y=i,tp(t),t},drag(e){if(e.parent.isSquare){let t=e.parent;return e.attached=!1,t[e.highlightedSlot]=void 0,tS(t,e),t.receiveNumber(t,void 0,e.channelId),e}if(!e.parent.isPaddle)return e;let l=e.parent;for(let i of(e.attached=!1,tS(l,e),l.rightTriangle=void 0,l.cellAtoms))if(void 0!==i.slotted){let{x:o,y:a}=tx(i.slotted);tS(l,i.slotted),i.slotted.cellAtom=void 0,i.slotted.attached=!1,i.slotted.x=o,i.slotted.y=a,i.slotted.slottee=!1,i.slotted=void 0}return e.colour!==Colour.splash(999)&&(e.hasBorder=!0,e.borderColour=Colour.Grey),l.pinhole.locked=!1,ln(l),e}},tX=10,t3=tD.size-2*tX,t1=t3+tX,tH=tX,t8={draw:tT.draw,overlaps:tT.overlaps,offscreen:tT.offscreen,grab:e=>e.parent,colour:Colour.Grey,width:tH+3*(tD.size+tH),height:tD.size,y:0,x:tD.size+tH,dragOnly:!0,isPicker:!0},tV={red:0,green:1,blue:2},tj=["red","green","blue",],tW={hasBorder:!0,draw:tT.draw,overlaps:tT.overlaps,offscreen:tT.offscreen,width:tD.size,y:(tD.size-t3)/2,height:t3,grab:e=>e,rightDraggable:!0,rightDrag(e){let t=tc(tW);tp(t);let{x:l,y:i}=tx(e);return e6.offset.x-=e.x-l,e6.offset.y-=e.y-i,t.value=H(e.value),e.expanded&&(t.createOptions(t),t.expanded=!0),t},drag(e){if(e.parent.isSquare){let t=e.parent;t[e.channelSlot]=void 0;let l=tV[e.channelSlot];t.receiveNumber(t,void 0,l),tS(t,e),e.channelSlot=tj[e.value.channel],e.updateColours(e),e.attached=!1,e.needsColoursUpdate=!0,e.colourTicker=1/0}else if(e.parent.isTallRectangle){let i=e.parent;tS(i,e),i.operationAtoms[e.highlightedSlot]=void 0;let o="padTop"===e.highlightedSlot?"add":"subtract";if(i.value[o]=void 0,e.attached=!1,i.expanded)i.unexpand(i),i.expand(i);else{let a="padTop"===e.highlightedSlot?"handleTop":"handleBottom";tb(i,i[a],{quiet:!0}),tb(i,i[e.highlightedSlot],{quiet:!0}),i.expand(i),i.unexpand(i)}}else if(e.parent.isPaddle){let r=e.parent;r.chance=void 0,tS(r,e),ln(r)}return e},construct(e){let t=Random.Uint8%3;e.value=X({values:[!1,!1,!1,!1,!1,!1,!1,!1,!1,!0],channel:t}),e.needsColoursUpdate=!0,e.colourId=0,e.dcolourId=1,e.colourTicker=1/0,e.selectionBack=tw(e,tK);let l=tw(e,t5);e.selectionTop=l,e.selectionTop.isTop=!0,l.dragOnly=!1;let i=tw(e,t5);e.selectionBottom=i,e.selectionBottom.isTop=!1,i.dragOnly=!1,e.positionSelection(e)},positionSelection(e,t,l,i,o){if(e.expanded){let a=t1;e.selectionTop.y=l-e.selectionTop.height,e.selectionBottom.y=t+a-e.selectionBottom.height,e.selectionTop.minY=i-e.selectionTop.height,e.selectionTop.maxY=e.selectionBottom.y-a,e.selectionBottom.minY=e.selectionTop.y+a,e.selectionBottom.maxY=o-e.selectionBottom.height+a}else e.selectionTop.y=-e.selectionTop.height,e.selectionBottom.y=e.height;e.positionSelectionBack(e);let r=e.children.indexOf(e.selectionTop);e.children.splice(r,1),e.children.push(e.selectionTop);let n=e.children.indexOf(e.selectionBottom);if(e.children.splice(n,1),e.children.push(e.selectionBottom),e.parent.isTallRectangle){let d="padTop"===e.highlightedSlot?"add":"subtract";e.parent.value[d]=e.value}},positionSelectionBack(e){e.selectionBack.x=-t5.height,e.selectionBack.y=e.selectionTop.y,e.selectionBack.height=e.selectionBottom.y-e.selectionTop.y+e.selectionTop.height,e.selectionBack.width=e.width+2*t5.height},update(e){if(e.expanded&&e.needsColoursUpdate&&(e.needsColoursUpdate=!1,e.isGradient=!0,e.gradient=tL({colours:e.colours,width:e.width*C,height:e.height*C,gradient:e.gradient}),e.updateColours(e)),!e.expanded&&e.needsColoursUpdate){if(e.needsColoursUpdate=!1,e.parent.isSquare){let t=[];for(let l=0;l<3;l++)if(l===e.value.channel)t[l]=e.value;else{let i=[!0,!1,!1,!1,!1,!1,!1,!1,!1,!1];t[l]=X({values:i,channel:l})}let o=Z({channels:t});e.colours=M(o)}else{let a;for(let r=0;r<10;r++){let n=e.value.values[r];if(!1===n)continue;let d=makeArrayFromSplash(`${r}${r}${r}`);void 0===a?a=d:a.joins.push(d)}e.colours=M(a)}e.isGradient=!0,e.gradient=tL({colours:e.colours,width:e.width*C,height:e.height*C,gradient:e.gradient})}if(e.highlightedAtom=void 0,e6.content===e&&e6.state===tr.DRAGGING){let{x:h,y:s}=tx(e),c=h,u=s,g=h+e.width,$=s+e.height;void 0!==e.highlight&&(tb(e,e.highlight),e.highlight=void 0);let p=1/0,f,v,m=lp();for(let _ of m){let w=_;if(w.isTallRectangle){if(!w.expanded)continue;let b=["padTop","padBottom"];for(let S of b){let R=w;for(;R.isTallRectangle&&void 0!==R.operationAtoms[S];)R=R.operationAtoms[S];if(!R.isTallRectangle||!R.expanded)continue;let T=R[S],{x:k,y:E}=tx(T),z=k,O=k+T.width,D=E,P=E+T.height;if(!(c>O)&&!(g<z)&&!($<D)&&!(u>P)){e.highlightedSlot=S,e.highlightedAtom=T;break}}}else{if(!_.isSquare||!_.expanded)continue;let{x:A,y:I}=tx(_.pickerPad),B=A,L=A+_.pickerPad.width,G=I,N=I+_.pickerPad.height;if(c>L||g<B||$<G||u>N)continue;let U=["red","green","blue"].filter(e=>void 0===_[e]);if(0===U.length)continue;let{x:Y,y:H}=tx(_);for(let V of U){let j=tV[V],W=Y+_.size+2*tX+j*(tD.size+tH),q=H+tX,F=Math.hypot(h-W,s-q);F<p&&(p=F,f=_,v=V)}}}if(void 0!==f){let{x:K,y:J}=tx(f),Q=tV[v];e.highlight=tw(e,lS,{bottom:!0}),e.highlight.hasBorder=!0,e.highlight.x=K+f.size+tX+Q*(tX+f.size),e.highlight.y=J,e.highlight.width=2*tX+f.size,e.highlightedAtom=f,e.highlightedSlot=v}else if(e.highlightedAtom){let{x:ee,y:et}=tx(e.highlightedAtom);e.highlight=tw(e,lS,{bottom:!0}),e.highlight.hasBorder=!0,e.highlight.x=ee,e.highlight.y=et,e.highlight.width=e.highlightedAtom.width,e.highlight.height=e.highlightedAtom.height}}void 0===e.highlightedAtom&&void 0!==e.highlight&&(tb(e,e.highlight),e.highlight=void 0)},drop(e){if(void 0!==e.highlight){if(e.highlightedAtom.isSquare){let t=e.highlightedAtom,l=tV[e.highlightedSlot];e.value.channel=l,t.receiveNumber(t,e.value,l,{expanded:e.expanded}),t$(e)}else{let i=e.highlightedAtom.parent,o="padTop"===e.highlightedSlot?"add":"subtract";i.value[o]=e.value,i.operationAtoms[e.highlightedSlot]=e,e.x=e.highlightedAtom.x+tX,e.y=e.highlightedAtom.y+e.highlightedAtom.height/2-e.height/2,e.dx=0,e.dy=0,t0(i,e),e.attached=!0}}else if(void 0!==e.highlightPaddle){let a=e.highlightedPaddle;e.attached=!0,t0(a,e),a.chance=e,ln(a),e.dx=0,e.dy=0}lU("triangle")},click(e){e.expanded?(e.expanded=!1,e.deleteOptions(e),e.needsColoursUpdate=!0):(e.expanded=!0,e.colourId=0,e.colourTicker=1/0,e.needsColoursUpdate=!0,e.createOptions(e))},deleteOptions(e){for(let t of(void 0!==e.options&&(e.deletedOptions=e.options),e.options))e!==t&&tb(e,t);e.needsColoursUpdate=!0,e.colourTicker=1/0,e.positionSelection(e)},updateColours(e){let t,l,i;if(e.parent.isSquare){let o=e.parent.value.channels[0],a=e.parent.value.channels[1],r=e.parent.value.channels[2];void 0===o&&(o=X({channel:0,values:[!0,!1,!1,!1,!1,!1,!1,!1,!1,!1]})),void 0===a&&(a=X({channel:1,values:[!0,!1,!1,!1,!1,!1,!1,!1,!1,!1]})),void 0===r&&(r=X({channel:2,values:[!0,!1,!1,!1,!1,!1,!1,!1,!1,!1]})),t=X({values:[...o.values],channel:o.channel}),l=X({values:[...a.values],channel:a.channel}),i=X({values:[...r.values],channel:r.channel})}else{let n=[!1,!1,!1,!1,!1,!1,!1,!1,!1,!1];t=X({values:[...n],channel:0}),l=X({values:[...n],channel:1}),i=X({values:[...n],channel:2})}let d=[t,l,i],h=d[tV[e.channelSlot]];if(void 0!==h&&(h.values=[!1,!1,!1,!1,!1,!1,!1,!1,!1,!1]),void 0!==e.options&&e.options.length>0)for(let s=0;s<10;s++){let c=e.options[s];if(e.parent.isSquare)h.values[9-s]=!0,s>0&&(h.values[9-s+1]=!1);else for(let u of d)u.values[9-s]=!0,s>0&&(u.values[9-s+1]=!1);let g=Z({channels:d}),$=M(g);c.colours=$,c.colourTicker=1/0,c!==e&&(c.needsColoursUpdateCountdown=s,c.needsColoursUpdate=!1)}},getCenterId(e){let t,l;for(let i=0;i<e.value.values.length;i++){let o=e.value.values[i];o&&(void 0===t&&(t=i),l=i)}return Math.round((l+t)/2)},getStartAndEndId(e){let t,l;for(let i=0;i<e.value.values.length;i++){let o=e.value.values[i];o&&(void 0===t&&(t=i),l=i)}return[t,l]},createOptions(e){let t=e.parent.isSquare?e.deletedOptions:void 0;e.options=[];let l,i;for(let o=0;o<e.value.values.length;o++){let a=e.value.values[o];a&&(void 0===l&&(l=o),i=o)}if(void 0===l)throw Error("[ColourTode] Number cannot be NOTHING. Please let @TodePond know if you see this error!");let r=e.getCenterId(e),n=t1,d=(r-9)*n,h=d+(9-l)*n,s=d+(9-i)*n;for(let c=0;c<10;c++){if(r===9-c){e.options.push(e);continue}let u=c!==9-i+1,g=c!==9-l-1,$=tw(e,{...t6,pityTop:u,pityBottom:g});void 0!==t&&($.isGradient=!0,$.gradient=t[c].gradient),$.y=d+c*n,$.value=9-c,$.needsColoursUpdateCountdown=c,$.needsColoursUpdate=!0,e.options.push($)}e.positionSelection(e,h,s,d,r*n),e.updateColours(e)}},tq=.13397460000000005,t2={colour:Colour.Black,hasBorder:!0,borderColour:Colour.Grey,width:tW.width,height:tW.width,overlaps:tT.overlaps,offscreen:tT.offscreen,draw(e){let{x:t,y:l}=tx(e),{width:i,height:o}=e,a=[[t+.2679492000000001*i,l],[t+.7320507999999999*i,l],[t+i,l+.8660254*o/2],[t+.7320507999999999*i,l+.8660254*o],[t+.2679492000000001*i,l+.8660254*o],[t,l+.8660254*o/2],];a=a.map(([e,t])=>[e,t+.13397460000000005/2*o]);let r=[];for(let n=0;n<6;n++){let d=wrap(n+1,0,5),h=a[n],s=a[d],c=[0,1].map(e=>(h[e]+s[e])/2);r.push(c)}let u=[t+i/2,l+o/2],g=a.map((e,t)=>{let l=wrap(t+1,0,5),i=a[wrap(t+1+1,0,5)],o=wrap(t+1+1,0,5),n=r[o],d=r[l];return[u,d,i,n]}),[$,...p]=a,f=new Path2D;for(let v of(f.moveTo(...$),p))f.lineTo(...v);if(f.closePath(),eJ.fillStyle=e.colour,eJ.fill(f),void 0!==e.ons)for(let m=0;m<6;m++){if(!e.ons[m])continue;let[_,...w]=g[m],b=new Path2D;for(let S of(b.moveTo(..._),w))b.lineTo(...S);b.closePath(),eJ.fillStyle=Colour.Silver,eJ.fill(b),eJ.lineWidth=1/C,eJ.strokeStyle=Colour.Silver,eJ.stroke(b)}e.hasBorder&&(eJ.lineWidth=1.5*tR,eJ.strokeStyle=e.borderColour,eJ.stroke(f),e.parent.isSquare&&lP.drawY(e,e.size-8,4))},getValue(e){let t=0;for(let l of e.ons)l&&t++;return t},click(e){e.expanded?e.unexpand(e):e.expand(e)},unexpand(e){for(let t of(e.expanded=!1,e.handles))tb(e,t);for(let l of e.buttons)tb(e,l);e.handles=[],e.buttons=[]},expand(e){e.expanded=!0,e.handles=[],e.buttons=[];let{width:t,height:l}=e,i=.22373758200000007*t,o=[[t,l/2-tM.height/2],[t-i,l-tM.height/2],[i,l-tM.height/2],[0,l/2-tM.height/2],[i,0-tM.height/2],[t-i,0-tM.height/2],],a=[[t,l/2],[t-i,l],[i,l],[0,l/2],[i,0],[t-i,0],];a=a.map(([t,l],i)=>{let[o,a]=[t-e.width/2,l-e.height/2],[r,n]=[];return i%3==0?[r,n]=[2.2*o,2.2*a]:[r,n]=[2*o,2*a],[r+e.width/2,n+e.height/2]});for(let r=0;r<6;r++){let n=tw(e,tM);n.rotation=r,n.x=o[r][0]-tM.width/2,n.y=o[r][1],e.handles.push(n);let d=tw(e,tF);d.x=a[r][0]-tF.size/2,d.y=a[r][1]-tF.size/2,e.buttons.push(d),d.id=r,e.ons[r]&&(d.inner.selected=!0,d.inner.colour=Colour.Silver)}},construct(e){e.ons=[!1,!1,!1,!1,!1,!1]},updateValue(e){let t=tV[e.variable],l=!e.ons[1]&&!e.ons[0]&&!e.ons[5],i=!e.ons[2]&&!e.ons[3]&&!e.ons[4],o=!l&&!i,a=[l||o,e.ons[1],e.ons[0],e.ons[5],!1,!1,!1,!1,!1,!1],r=[i||o,e.ons[2],e.ons[3],e.ons[4],!1,!1,!1,!1,!1,!1],n=X({values:a}),d=X({values:r}),h=X({channel:t,variable:e.variable,add:n,subtract:d});e.value=h},hover(e){let{x:t,y:l}=tx(e),i=t,o=l,a=t+e.width,r=l+e.height;for(let n of paddles){let{x:d,y:h}=tx(n),s=d+n.width,c=h,u=h+n.height;if(void 0===n.chance&&n.expanded&&i<=s&&a>=s&&(o<u&&o>c||r>c&&r<u))return void 0!==e.highlightPaddle&&tb(e,e.highlightPaddle),e.highlight=tw(e,lS,{bottom:!0}),e.highlight.width=l0,e.highlight.height=n.height,e.highlight.y=c,e.highlight.x=s-l0/2,n}},place(e,t){t.isPaddle&&(e.attached=!0,t0(t,e),t.chance=e,ln(t),e.dx=0,e.dy=0)},drag(e){if(e.parent.isPaddle){let t=e.parent;tS(t,e),t.chance=void 0,ln(t)}else if(e.parent.isSquare){let l=e.parent;l[e.variable]=void 0;let i=tV[e.variable];l.receiveNumber(l,void 0,i),tS(l,e),e.attached=!1}return e},rightDraggable:!0,rightDrag(e){let t=e.clone(e);return tp(t),e6.offset.x-=e.x-t.x,e6.offset.y-=e.y-t.y,t},clone(e){let t=tc(t2);for(let l=0;l<6;l++)t.ons[l]=e.ons[l];e.expanded&&t.expand(t);let{x:i,y:o}=tx(e);return t.x=i,t.y=o,t}},tZ=([e,t],[l,i],o)=>{let[a,r]=[e-l,t-i],n=Math.sqrt(a**2+r**2),d=Math.atan2(r,a),[h,s]=[n*Math.cos(o+d),n*Math.sin(o+d),];return[l+h,i+s]},tF={size:tD.size,offscreen:tk.offscreen,overlaps:tk.overlaps,colour:Colour.Grey,grab:e=>e.parent,behindChildren:!0,draw(e){tk.draw(e)},construct(e){e.inner=tw(e,t4,{bottom:!1}),e.inner.x=e.width/2-e.inner.width/2,e.inner.y=e.height/2-e.inner.height/2},click(e){e.inner.selected?(e.inner.selected=!1,e.inner.colour=Colour.Grey):(e.inner.selected=!0,e.inner.colour=Colour.Silver);let t=e.parent;if(t.ons[e.id]=e.inner.selected,t.parent.isPaddle){let l=t.parent;ln(l)}else if(t.parent.isSquare){let i=t.parent;t.updateValue(t);let o=tV[t.variable];i.receiveNumber(i,t.value,o,{expanded:t.expanded,numberAtom:t})}ty(e.parent)}},t4={size:2*tD.size/3,offscreen:tk.offscreen,overlaps:tk.overlaps,grab:e=>e.parent,touch:e=>e.parent,draw:tk.draw,hasBorder:!0,borderColour:Colour.Black,colour:Colour.Grey},tM={offscreen:tT.offscreen,overlaps(e,t,l){e.y-=e.height/2,e.height*=2;let i=tT.overlaps(e,t,l);return e.height/=2,e.y+=e.height/2,i},colour:Colour.Grey,rotation:0,touch:e=>e.parent,grab:e=>e.parent,x:50,width:tD.size/2+tD.size/4,height:tD.size/3,draw(e){let{x:t,y:l}=tx(e),{width:i,height:o}=e,a=new Path2D,r=[[t,l],[t+i,l],[t+i,l+o],[t,l+o],];e.rotation>0&&(r=r.map(a=>tZ(a,[t+i/2,l+o/2],e.rotation*Math.PI/3)));let[n,...d]=r;for(let h of(a.moveTo(...n),d))a.lineTo(...h);eJ.fillStyle=e.colour,eJ.fill(a)}},t5={draw(e){let{x:t,y:l}=tx(e),i=Math.round(e.width),o=Math.round(e.height);eJ.fillStyle=Colour.Grey,eJ.fillRect(Math.round(t),Math.round(l),i,o)},overlaps:tT.overlaps,offscreen:tT.offscreen,height:t1-t3,width:tD.size+2*tX,x:-tX,dragOnly:!0,grab:e=>e.parent.expanded?e:e.parent,touch:e=>e.parent.expanded?e:e.parent,cursor:e=>e.parent.expanded?"ns-resize":"pointer",move(e){e.parent.positionSelectionBack(e.parent)},drop(e){let t=Math.round((e.y+t3/2)/t1),l=e.parent.value,[i,o]=e.parent.getStartAndEndId(e.parent),a=e.parent.getCenterId(e.parent);e.isTop&&(o=a-t),e.isTop||(i=a-(t-1));let r=[!1,!1,!1,!1,!1,!1,!1,!1,!1,!1];for(let n=i;n<=o;n++)r[n]=!0;let d=X({channel:l.channel,values:r});if(e.parent.value=d,e.parent.deleteOptions(e.parent),e.parent.createOptions(e.parent),e.dx=0,e.dy=0,e.parent.parent.isSquare){let h=e.parent.parent,s=tV[e.parent.channelSlot];h.receiveNumber(h,d,s)}if(e.parent.parent.isPaddle){let c=e.parent.parent;ln(c)}},dragLockX:!0},tK={overlaps:tT.overlaps,offscreen:tT.offscreen,width:(tD.size-t3)/2,height:tD.size,grab:e=>e.parent,touch:e=>e.parent,dragLockX:!0,draw:tT.draw,colour:Colour.Grey},t6={draw:tT.draw,overlaps:tT.overlaps,offscreen:tT.offscreen,height:t3,width:tD.size,grab:e=>e.parent,hasBorder:!0,colourTicker:1/0,colours:[999],colourId:0,dcolourId:1,update(e){e.needsColoursUpdateCountdown>=0&&(e.needsColoursUpdateCountdown--,e.needsColoursUpdateCountdown<0&&(e.needsColoursUpdate=!0)),e.needsColoursUpdate&&(e.updateColours(e),e.needsColoursUpdateCountdown=-1,e.needsColoursUpdate=!1)},getId(e){let t=e.parent,l=t.getCenterId(t),i=e.y/t1;return l-i},updateColours(e){e.isGradient=!0,e.gradient=tL({colours:e.colours,width:e.width*C,height:e.height*C,gradient:e.gradient})},touch(e){let t=e.getId(e);return e.parent.value.values[t]?e.parent:e},click(e){let t=[!1,!1,!1,!1,!1,!1,!1,!1,!1,!1];t[e.value]=!0;let l=X({values:t,channel:e.parent.value.channel}),i=e.parent;if(i.value=l,i.deleteOptions(i),i.createOptions(i),i.needsColoursUpdate=!0,i.parent.isSquare){let o=i.parent,a=tV[i.channelSlot];o.receiveNumber(o,l,a)}if(i.parent.isPaddle){let r=i.parent;ln(r)}},construct(e){if(e.pityTop){let t=tw(e,lt);t.y=-t.height}if(e.pityBottom){let l=tw(e,lt);l.y=e.height}}},t9=["red","green","blue",],tJ={behindChildren:!0,highlighter:!0,rightDraggable:!0,rightDrag(e){let t=tc(tJ);tp(t);let{x:l,y:i}=tx(e);return e6.offset.x-=e.x-l,e6.offset.y-=e.y-i,t.variable=e.variable,e.expanded&&t.expand(t),t.updateAppearance(t),t},drag(e){if(e.parent.isSquare){let t=e.parent;t[e.channelSlot]=void 0;let l=tV[e.channelSlot];t.receiveNumber(t,void 0,l),tS(t,e),e.updateAppearance(e),e.attached=!1}else if(e.parent.isTallRectangle){let i=e.parent;tS(i,e),i.operationAtoms[e.highlightedSlot]=void 0;let o="padTop"===e.highlightedSlot?"add":"subtract";if(i.value[o]=void 0,e.expanded&&(e.unexpand(e),e.expand(e)),e.attached=!1,i.expanded)i.unexpand(i),i.expand(i);else{let a="padTop"===e.highlightedSlot?"handleTop":"handleBottom";tb(i,i[a],{quiet:!0}),tb(i,i[e.highlightedSlot],{quiet:!0}),i.expand(i),i.unexpand(i)}}return e},hover(e){let{x:t,y:l}=tx(e),i=t,o=l,a=t+e.width,r=l+e.height,n=1/0,d,h,s=lp();for(let c of s){if(c===e)continue;if(c.isTallRectangle){if(!c.expanded)continue;let u=["padTop","padBottom"];for(let g of u){let $=c;for(;$.isTallRectangle&&void 0!==$.operationAtoms[g];)$=$.operationAtoms[g];if(!$.isTallRectangle||!$.expanded)continue;let p=$[g],{x:f,y:v}=tx(p),m=f,_=f+p.width,w=v,b=v+p.height;if(!(i>_)&&!(a<m)&&!(r<w)&&!(o>b))return e.highlightedSlot=g,p}continue}if(!c.isSquare||!c.expanded)continue;let{x:S,y:R}=tx(c.pickerPad),C=S,T=S+c.pickerPad.width,k=R,E=R+c.pickerPad.height;if(i>T||a<C||r<k||o>E)continue;let z=["red","green","blue"].filter(e=>void 0===c[e]);if(0===z.length)continue;let{x:O,y:D}=tx(c);for(let P of z){let A=tV[P],I=O+c.size+2*tX+A*(tD.size+tH),B=D+tX,L=Math.hypot(t-I,l-B);L<n&&(n=L,h=P,d=c)}if(void 0!==d){let{x:G,y:N}=tx(d),U=tV[h];e.highlight=tw(e,lS,{bottom:!0}),e.highlight.hasBorder=!0,e.highlight.x=G+d.size+tX+U*(tX+d.size),e.highlight.y=N,e.highlight.width=2*tX+d.size,e.highlightedAtom=d,e.highlightedSlot=h}return}},place(e,t){if(e.attached=!0,e.dx=0,e.dy=0,!t.isSquare){let l=t.parent,i="padTop"===e.highlightedSlot?"add":"subtract";l.value[i]=e.value,l.operationAtoms[e.highlightedSlot]=e,e.x=0,e.y=t.y+t.height/2-e.height/2,t0(l,e),e.expanded&&(e.unexpand(e),e.expand(e));return}let o=e.highlightedAtom,a=tV[e.highlightedSlot];o.receiveNumber(o,e.value,a,{expanded:e.expanded,numberAtom:e}),t$(e)},draw(e){let{x:t,y:l}=tx(e),i=e.size,o=i,a=i,r=t,n=l,d=n+o/2,h=r+a/2;eJ.fillStyle=e.colour;let s=new Path2D;s.moveTo(...[h,n].map(e=>e)),s.lineTo(...[r+a,d].map(e=>e)),s.lineTo(...[h,n+o].map(e=>e)),s.lineTo(...[r,d].map(e=>e)),s.closePath(),eJ.fillStyle=e.colour,eJ.fill(s),e.hasBorder&&(eJ.lineWidth=tR,eJ.strokeStyle=e.borderColour,e.isTool&&(eJ.lineWidth=1.5*tR,eJ.strokeStyle=tC[e.colour.splash]),eJ.stroke(s))},offscreen:tT.offscreen,overlaps:tT.overlaps,hasBorder:!0,isTallRectangle:!0,size:t3+tX/3*2,height:t3+tX/3*2,width:t3+tX/3*2,construct(e){e.variable=t9[Random.Uint8%3],e.value=X({variable:e.variable}),e.updateAppearance(e),e.isTool||(e.width+=tR/2,e.height+=tR/2,e.size+=tR/2),e.operationAtoms={padTop:void 0,padBottom:void 0}},makeOperationAtoms(e){if(void 0!==e.value.add&&void 0===e.operationAtoms.padtop){if(void 0===e.value.add.variable){let t=tw(e,tW);t.value=e.value.add,e.operationAtoms.padTop=t,t.x=e.padTop.x+tX,t.y=e.padTop.y+e.padTop.height/2-t.height/2,t.highlightedSlot="padTop"}else{let l=tw(e,tJ);l.value=e.value.add,l.variable=e.value.add.variable,l.makeOperationAtoms(l),l.highlightedSlot="padTop",l.x=0,l.y=e.padTop.y+e.padTop.height/2-l.height/2,l.updateAppearance(l),e.operationAtoms.padTop=l}}if(void 0!==e.value.subtract&&void 0===e.operationAtoms.padBottom&&void 0===e.value.subtract.variable){let i=tw(e,tW);i.value=e.value.subtract,e.operationAtoms.padBottom=i,i.x=e.padBottom.x+tX,i.y=e.padBottom.y+e.padBottom.height/2-i.height/2,i.highlightedSlot="padBottom"}},updateAppearance(e){"red"===e.variable?e.colour=Colour.Red:"green"===e.variable?e.colour=Colour.Green:"blue"===e.variable&&(e.colour=Colour.Blue),e.borderColour=borderColours[e.colour.splash]},expanded:!1,click(e){e.expanded?e.unexpand(e):e.expand(e)},expand(e){for(let t of(e.expanded=!0,void 0===e.value.add&&(e.y<0||!(e.parent.isTallRectangle&&e.parent.operationAtoms.padBottom===e))&&(e.handleTop=tw(e,lk),e.handleTop.width=e.handleTop.height,e.handleTop.height*=2,e.handleTop.y=e.height/2-e.handleTop.height,e.handleTop.x=e.width/2-e.handleTop.width/2,e.handleTop.behindParent=!0,e.padTop=tw(e,lT),e.padTop.height=t8.height,e.padTop.width=tD.size+2*tH,e.padTop.x=e.width/2-e.padTop.width/2,e.padTop.y=-e.padTop.height-tX),void 0===e.value.subtract&&(e.y>0||!(e.parent.isTallRectangle&&e.parent.operationAtoms.padTop===e))&&(e.handleBottom=tw(e,lk),e.handleBottom.width=e.handleBottom.height,e.handleBottom.height*=2,e.handleBottom.y=e.height/2,e.handleBottom.x=e.width/2-e.handleBottom.width/2,e.handleBottom.behindParent=!0,e.padBottom=tw(e,lT),e.padBottom.height=t8.height,e.padBottom.width=tD.size+2*tH,e.padBottom.x=e.width/2-e.padBottom.width/2,e.padBottom.y=e.height+tX),e.handleRight=tw(e,lk),e.handleRight.y=e.height/2-e.handleRight.height/2,e.handleRight.x=e.width/2,e.handleRight.width*=2.5,e.handleRight.behindParent=!0,e.padRight=tw(e,lT),e.padRight.height=t8.height,e.padRight.width=tX+(e.width+tX/1.5)*3,e.padRight.y=e.height/2-e.padRight.height/2,e.padRight.x=e.width/2+(tD.size+2*tH)/2+tX,e.red=tw(e,tQ),e.red.x=e.padRight.x+tX/Math.SQRT2,e.red.borderColour=Colour.Red,e.red.colour=Colour.Black,e.red.value="red",e.green=tw(e,tQ),e.green.x=e.padRight.x+tX/Math.SQRT2+(e.green.width+tX)*1,e.green.borderColour=Colour.Green,e.green.colour=Colour.Black,e.green.value="green",e.blue=tw(e,tQ),e.blue.x=e.padRight.x+tX/Math.SQRT2+(e.blue.width+tX)*2,e.blue.borderColour=Colour.Blue,e.blue.colour=Colour.Black,e.blue.value="blue",e.winnerPin=tw(e,le),e.winnerPin.x=e[e.variable].x+e.winnerPin.width/2,e.winnerPin.y=e.winnerPin.height/2,e.winnerPin.colour=e[e.variable].borderColour,e.winnerPin.borderColour=e.winnerPin.colour,["padTop","padBottom"])){let l=e.operationAtoms[t];void 0!==l&&(tp(l),t0(e,l))}for(let i of e.children)i.isTallRectangle&&i.expanded&&(i.unexpand(i),i.expand(i))},unexpand(e){e.expanded=!1,tb(e,e.red),tb(e,e.green),tb(e,e.blue),tb(e,e.padRight),tb(e,e.handleRight),tb(e,e.winnerPin),void 0===e.value.add&&(tb(e,e.padTop,{quiet:!0}),tb(e,e.handleTop,{quiet:!0})),void 0===e.value.subtract&&(tb(e,e.padBottom,{quiet:!0}),tb(e,e.handleBottom,{quiet:!0}))}},tQ={draw(e){tJ.draw(e)},offscreen:tT.offscreen,overlaps:tT.overlaps,hasBorder:!0,size:t3+tX/3*2,height:t3+tX/3*2,width:t3+tX/3*2,grab:e=>e.parent,click(e){if(e.value===e.parent.variable)return;e.parent.variable=e.value,e.parent.value.variable=e.value,e.parent.winnerPin.x=e.x+e.parent.winnerPin.width/2,e.parent.winnerPin.colour=e.borderColour,e.parent.winnerPin.borderColour=e.borderColour,e.parent.updateAppearance(e.parent);let t=e.parent,l=t,i=t.parent;for(;!i.isSquare;){if(i===ts)return;l=i,i=i.parent}let o=0;"green"===l.channelSlot&&(o=1),"blue"===l.channelSlot&&(o=2);let a=i.variableAtoms[o];i.receiveNumber(i,a.value,o,{expanded:a.expanded,numberAtom:a})}},le={draw(e){tJ.draw(e)},offscreen:tT.offscreen,overlaps:tT.overlaps,hasBorder:!0,size:(t3+tX/3*2)/2,height:(t3+tX/3*2)/2,width:(t3+tX/3*2)/2,grab:e=>e.parent,touch:e=>e.parent},lt={draw(){},overlaps:tT.overlaps,offscreen:tT.offscreen,grab:e=>e.parent.parent,touch:e=>e.parent,colour:Colour.Grey,width:tD.size,height:t1-t3,y:0,x:0};paddles=[];let ll=tD.size/2,li={stayAtBack:!0,attached:!0,noDampen:!0,isPaddle:!0,behindChildren:!0,draw:tT.draw,overlaps:tT.overlaps,offscreen:tT.offscreen,colour:Colour.Grey,size:tD.size+4*tX,width:tD.size+4*tX,height:tD.size+4*tX,dragOnly:!0,dragLockY:!0,scroll:0,rightTriangle:void 0,x:Math.round(ll),y:tD.size+tX+ll,construct(e){e.cellAtoms=[],e.slots=[];let t=tw(e,ly);e.handle=t,e.setLimits(e),e.x=e.minX,e.expanded=!1,e.pinhole=tw(t,l_),e.dummyLeft=tw(e,la),e.dummyLeft.visible=!1,e.dummyRight=tw(e,la),e.dummyRight.visible=!1,ln(e)},setLimits(e){e.maxX=e.handle.width,e.minX=e.handle.width-e.width},drop(e){let t=e.maxX-e.x,l=e.x-e.minX;t<l?(e.x=e.maxX,e.expanded=!0,lg(e),paddles.last===e&&lm()):(e.x=e.minX,e.expanded=!1,lg(e),paddles.last!==e&&lv(e)),e.dx=0},click(e){let t=lu(e.cellAtoms),l=makeDiagram({left:t});tO(l)},drag:(e,t,l)=>e,rightDraggable:!0,getColour(e){let t=e.cellAtoms;if(0===t.length){let l=Z({channels:[void 0,void 0,void 0]});return l}if(1===t.length){let i=Q(t[0].value);return i}let o=lu(t),a=makeDiagram({left:o});return el(a),a},rightDrag(e){let t=e.cellAtoms;if(0===t.length){let l=tc(tD);e6.offset.x=-l.width/2,e6.offset.y=-l.height/2;let i=Z({channels:[void 0,void 0,void 0]});return tO(i),tp(l),l.value=i,l.update(l),l}if(1===t.length){let o=Q(t[0].value),a=t[0].clone(t[0]);return e6.offset.x=-a.width/2,e6.offset.y=-a.height/2,tO(o),tp(a),a.value=o,a.update(a),a}let r=tc(tD);e6.offset.x=-r.width/2,e6.offset.y=-r.height/2;let n=lu(t),d=makeDiagram({left:n});return el(d),r.value=d,tp(r),tO(d),r.update(r),r}},lo=(e,t)=>{let l=new Path2D,[i,...o]=t;for(let a of(l.moveTo(...i.map(e=>Math.round(e))),o))l.lineTo(...a.map(e=>Math.round(e)));l.closePath(),eJ.fillStyle=e,eJ.fill(l)},la={visible:!0,isSlot:!0,behindChildren:!0,draw(e){if(!e.visible)return;let[t,l]=tx(e);e.width,e.height,eJ.fillStyle=e.colour;let i=e.width/3,o=e.width/3,a=t+e.width/2-i/2,r=l+e.height/2-o/2;eJ.fillRect(...[a,r,i,o].map(e=>Math.round(e)))},offscreen:tT.offscreen,overlaps:tT.overlaps,colour:Colour.Black,size:tD.size,grab:e=>e.parent,dragOnly:!0},lr=tD.size,ln=e=>{let t=li.width,l=li.size;if(e.cellAtoms.length>0){let i=1/0,o=-1/0,a=-1/0,r=1/0;for(let n of e.cellAtoms){let d=n.x,h=n.y,s=d,c=d+lr,u=h,g=h+lr;s<r&&(r=s),c>a&&(a=c),u<i&&(i=u),g>o&&(o=g)}let $=0,p=0,f=li.height/2-tD.size/2,v=li.width/2-tD.size/2,m=f,_=v;for(let w of(i!==m&&(o+=$=m-i),r!==_&&(a+=p=_-r),e.cellAtoms))w.y+=$,w.x+=p;let b=a+v,S=o+f;t=b,l=S}for(let R of(void 0!==e.rightTriangle&&(e.rightTriangle.x=t,e.rightTriangle.y=l/2-e.rightTriangle.height/2,t=t+t+e.rightTriangle.width),(e.hasSymmetry||void 0!==e.chance)&&(t+=lb.size/3),e.width=t,e.height=l,e.setLimits(e),e.slots))tb(e,R);if(e.slots=[],void 0!==e.rightTriangle)for(let C of e.cellAtoms){let T=tw(e,la,{bottom:!0});C.slot=T,e.slots.push(T),T.x=C.x+e.rightTriangle.x+e.rightTriangle.width,T.y=C.y,T.cellAtom=C,void 0!==C.slotted&&(C.slotted.x=C.x+e.rightTriangle.x+e.rightTriangle.width,C.slotted.y=C.y,T.colour=Colour.Grey)}void 0!==e.rightTriangle&&(void 0!==e.cellAtoms[0]&&void 0!==e.cellAtoms[0].slot?e.offset=e.cellAtoms[0].slot.x-e.cellAtoms[0].x:e.offset=0),void 0!==e.symmetryCircle&&(e.symmetryCircle.x=e.width-e.symmetryCircle.width/2,e.symmetryCircle.y=e.height/2-e.symmetryCircle.height/2),void 0!==e.chance&&(e.chance.x=e.width-e.chance.width/2,e.chance.y=e.height/2-e.chance.height/2),void 0!==e.chance&&void 0!==e.symmetryCircle&&(e.symmetryCircle.y-=e.symmetryCircle.height/2,e.chance.y+=e.symmetryCircle.height/2,e.height>100&&(e.symmetryCircle.y-=tX/2,e.chance.y+=tX/2)),e.handle.y=e.height/2-e.handle.height/2,0===e.cellAtoms.length&&(e.dummyLeft.x=ll,e.dummyLeft.y=e.height/2-e.dummyLeft.height/2,e.dummyRight.x=e.width-ll-e.dummyLeft.width,e.dummyRight.y=e.height/2-e.dummyRight.height/2),lg(e),lf()},ld=e=>{let t=F(e);return 1===t.size},lh=(e,t)=>{for(let l=0;l<3;l++){let i=e.channels[l],o=t.channels[l];if(void 0===i&&void 0!==o||void 0!==i&&void 0===o||(void 0!==i||void 0!==o)&&i.variable!==o.variable)return!1}let a=M(e),r=M(t);for(let n of a){let d=r.indexOf(n);if(-1===d)return!1;r.splice(d,1)}return!(r.length>0)},ls=(e,t)=>{if(t.stamp)return;let l=ld(t);if(!l){let i;for(let o=0;o<e.length;o++){let a=e[o];if(lh(a,t)){i=o;break}}void 0===i&&(i=e.length,e.push(t)),t.stamp=i.toString()}},lc=e=>{let t=[...e].sort((e,t)=>e.x<t.x?-1:e.x>t.x?1:e.y<t.y?-1:e.y>t.y?1:0);return t},lu=e=>{let t=lc(e),l=t[0],i=[];for(let o of e){let a=(o.x-l.x)/o.width,r=(o.y-l.y)/o.height,n=Q(o.value),d=makeDiagramCell({x:a,y:r,content:n});i.push(d)}return i},lg=e=>{if(!e.expanded)return;void 0!==e.rightTriangle&&(e.pinhole.locked?e.rightTriangle.colour=Colour.splash(999):e.rightTriangle.colour=Colour.splash(0));let t=DRAGON_TRANSFORMATIONS.NONE;if(e.hasSymmetry){let[l,i,o]=lw(e.symmetryCircle.value),a=l>0,r=i>0,n=o>0,d=`${r?"X":""}${a?"Y":""}${n?"R":""}`;""===d?d="NONE":("XR"===d||"YR"===d)&&(d="XYR"),t=DRAGON_TRANSFORMATIONS[d]}let h=lc(e.cellAtoms),s=h[0],c=[],u=[],g=[];for(let $ of h){let p=($.x-s.x)/$.width,f=($.y-s.y)/$.height;if($.isLeftSlot){let v=X({values:[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0],channel:0}),m=X({values:[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0],channel:1}),_=X({values:[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0],channel:2}),w=Z({channels:[v,m,_]});ls(g,w);let b=makeDiagramCell({x:p,y:f,content:w});c.push(b)}else if($.value.isDiagram){let S=lc($.value.left);for(let R of S){let C=Q(R.content);ls(g,C);let T=p+R.x,k=f+R.y,E=makeDiagramCell({x:T,y:k,width:R.width,height:R.height,content:C});c.push(E)}}else{let z=Q($.value);ls(g,z);let O=makeDiagramCell({x:p,y:f,content:z});c.push(O)}if(!$.isLeftSlot&&$.value.isDiagram){let D=ei($.value),[P,A]=eo(D),I=makeDiagramCell({x:p,y:f,instruction:DRAGON_INSTRUCTION.merge,splitX:P,splitY:A});u.push(I)}let B=void 0===$.slotted?void 0:$.slotted.value;if(void 0===B){let L=makeDiagramCell({x:p,y:f,instruction:DRAGON_INSTRUCTION.nothing});u.push(L)}else if(B.isDiagram){let G=ei(B),[N,U]=eo(G),Y=makeDiagramCell({x:p,y:f,instruction:DRAGON_INSTRUCTION.split,splitX:N,splitY:U});u.push(Y);let H=lc(B.left);for(let V of H){let j=Q(V.content);ls(g,j);let W=p+V.x,q=f+V.y,F=makeDiagramCell({x:W,y:q,width:V.width,height:V.height,content:j,instruction:DRAGON_INSTRUCTION.recolour});u.push(F)}}else{let M=Q(B);ls(g,M);let K=makeDiagramCell({x:p,y:f,content:M});u.push(K)}}let J=ei(makeDiagram({left:c,right:u})),ee=e.pinhole.locked,et=void 0===e.chance?void 0:e.chance.getValue(e.chance),el=makeRule({steps:[J],transformations:t,locked:ee,chance:et});e.rule=el,void 0!==e.registry&&ed(e.registry),ee&&void 0!==e.rightTriangle&&(e.registry=registerRule(el))},l$=(e=state.colourTode.atoms)=>{let t=[...e];for(let l of t)t.push(...l$(l.children));return t},lp=()=>{let e=[...state.colourTode.atoms];for(let t of paddles)for(let l of t.children)!l.isPinhole&&(l.isPaddleHandle||e.push(l));for(let i of e)i.isSquare&&i.expanded&&e.push(...i.children);return e},lf=()=>{if(paddles.length>1&&lU("triangle"),paddles.length>2){let e=0;for(let t of paddles)void 0!==t.rightTriangle&&e++;e>=2&&lU("hexagon")}let l;for(let i of paddles){if(void 0===l){i.y=li.y+li.scroll,l=i;continue}i.y=l.y+l.height+ll,l=i}},lv=(e,t=paddles.indexOf(e))=>{paddles.splice(t,1),void 0!==e.registry&&ed(e.registry),t$(e),lf()},lm=()=>{let e=tc(li);return paddles.push(e),lf(),tp(e),e},ly={isPaddleHandle:!0,attached:!0,behindChildren:!0,draw:tT.draw,overlaps:tT.overlaps,offscreen:tT.offscreen,colour:Colour.Grey,size:li.x,x:-li.x,y:li.size/2-li.x/2,touch:e=>e.parent.pinhole,grab:e=>e.parent.pinhole},l_={isPinhole:!0,attached:!0,locked:!1,borderScale:.5,borderColour:Colour.Black,draw(e){e.locked?(e.hasBorder=!0,e.colour=Colour.Grey):(e.hasBorder=!1,e.colour=Colour.Black),tk.draw(e)},overlaps:tk.overlaps,offscreen:tk.offscreen,colour:Colour.Black,size:ly.size-tX/2,y:tX/2/2,x:tX/2/2,click(e){let t=e.parent,l=t.parent;if(e.locked)e.locked=!1,l.grabbable=!0,t.draggable=!0,l.draggable=!0,e.draggable=!0,lg(l);else{for(let i of(e.locked=!0,t.draggable=!1,e.draggable=!1,l.cellAtoms)){if(i.expanded&&i.unexpand(i),void 0!==i.slotted){let o=i.slotted;o.expanded&&o.unexpand(o)}i.joins.length>0&&i.joinExpanded&&i.joinUnepxand(i)}0===l.cellAtoms.length&&(l.grabbable=!1,l.draggable=!1),lg(l)}},grab:e=>e.parent.parent},lx=new Map;lx.set(0,DRAGON_TRANSFORMATIONS.NONE),lx.set(100,DRAGON_TRANSFORMATIONS.X),lx.set(10,DRAGON_TRANSFORMATIONS.Y),lx.set(110,DRAGON_TRANSFORMATIONS.XY),lx.set(1,DRAGON_TRANSFORMATIONS.R),lx.set(111,DRAGON_TRANSFORMATIONS.XYR),lx.set(101,DRAGON_TRANSFORMATIONS.XYR),lx.set(11,DRAGON_TRANSFORMATIONS.XYR);let lw=getRGB,lb={hasBorder:!0,draw(e){if(tk.draw(e),void 0===e.value)return;let[t,l,i]=lw(e.value);t>0&&lD.drawX(e),l>0&&lP.drawY(e),i>0&&lA.drawR(e)},offscreen:tk.offscreen,overlaps:tk.overlaps,expanded:!1,borderColour:Colour.Grey,colour:Colour.Black,value:0,click(e){e.expanded?e.unexpand(e):e.expand(e)},expand(e){e.pad=tw(e,lT),e.handle=tw(e,lk),e.handle.width+=tX,e.expanded=!0;let[t,l,i]=lw(e.value);e.xToggle=tw(e,lD),e.yToggle=tw(e,lP),e.rToggle=tw(e,lA),t>0&&(e.xToggle.value=!0),l>0&&(e.yToggle.value=!0),i>0&&(e.rToggle.value=!0)},unexpand(e){tb(e,e.pad),tb(e,e.handle),tb(e,e.xToggle),tb(e,e.yToggle),tb(e,e.rToggle),e.expanded=!1},size:tD.size,update(e){let{x:t,y:l}=tx(e),i=state.colourTode.atoms.indexOf(e),o=t,a=l,r=t+e.width,n=l+e.height;if(e6.content===e)for(let d of paddles){let h=state.colourTode.atoms.indexOf(d),{x:s,y:c}=tx(d),u=s+d.width,g=c,$=c+d.height;if(!d.hasSymmetry&&d.expanded&&i>h&&o<=u&&r>=u&&(a<$&&a>g||n>g&&n<$)){void 0!==e.highlightPaddle&&tb(e,e.highlightPaddle),e.highlightPaddle=tw(e,lS,{bottom:!0}),e.highlightPaddle.width=l0,e.highlightPaddle.height=d.height,e.highlightPaddle.y=g,e.highlightPaddle.x=u-l0/2,e.highlightedPaddle=d;return}}void 0!==e.highlightPaddle&&(tb(e,e.highlightPaddle),e.highlightPaddle=void 0,e.highlightedPaddle=void 0)},drop(e){if(!e.attached&&void 0!==e.highlightedPaddle){let t=e.highlightedPaddle;e.attached=!0,t0(t,e),t.hasSymmetry=!0,t.symmetryCircle=e,ln(t),e.dx=0,e.dy=0}},drag(e){if(e.attached){let t=e.parent;e.attached=!1,tS(t,e),t.hasSymmetry=!1,t.symmetryCircle=void 0,ln(t)}return e},rightDraggable:!0,rightDrag(e){let t=tc(lb);t.value=e.value;let{x:l,y:i}=tx(e);return e6.offset.x-=e.x-l,e6.offset.y-=e.y-i,t.x=l,t.y=i,tp(t),t}},l0=tR,lS={behindParent:!0,draw:tT.draw,offscreen:tT.offscreen,overlaps:tT.overlaps,draggable:!1,grabbable:!1,justVisual:!0,colour:Colour.splash(999),borderColour:Colour.splash(999),hasAbsolutePosition:!0,hasInner:!1},lR={draw:tT.draw,offscreen:tT.offscreen,overlaps:tT.overlaps,dragOnly:!0,width:lb.size,x:lb.size*Math.sqrt(3)/2+tX,height:2*lb.size-tX,y:-lb.size/2+tX/2,colour:Colour.Grey,grab:e=>e.parent},lC={draw:tT.draw,offscreen:tT.offscreen,overlaps:tT.overlaps,dragOnly:!0,width:lb.size/2+tX,x:lb.size/2,height:lb.size/3,y:lb.size/2-lb.size/3/2,colour:Colour.Grey,grab:e=>e.parent},lT={draw:tT.draw,offscreen:tT.offscreen,overlaps:tT.overlaps,dragOnly:!0,width:lb.size,x:lb.size+tX,height:3*lb.size-tX,y:-(3*lb.size)/3+tX/2,colour:Colour.Grey,grab:e=>e.parent},lk={draw:tT.draw,offscreen:tT.offscreen,overlaps:tT.overlaps,dragOnly:!0,width:lb.size/2,x:lb.size/2+lb.size/4,height:lb.size/3,y:lb.size/2-lb.size/3/2,colour:Colour.Grey,grab:e=>e.parent},lE=(e,t)=>{switch(t=!t,e){case"right":return t?"down":"up";case"down":return t?"left":"right";case"left":return t?"up":"down";case"up":return t?"right":"left"}throw Error("Invalid rotation or clockwiseness")},lz={hasBorder:!0,colour:Colour.Black,borderColour:Colour.Black,draw(e){tN.draw(e)},touch:e=>(e.colour=Colour.Silver,e),click(e){let t=e.parent;e.colour=Colour.Black,t.direction=lE(t.direction,!0),e.value=!0,t.updateValue(t);let l=t.parent;l.isSquare&&l.receiveNumber(l,t.value,t.channelId,{expanded:t.expanded,numberAtom:t})},offscreen:tN.offscreen,overlaps:tN.overlaps,value:!1,size:tD.size-1.5*tX,grab:e=>e.parent,x:lR.x+lR.width/2-(tD.size-1.5*tX)/2,y:lR.y+1.5*tX/2},lO={hasBorder:!0,colour:Colour.Black,borderColour:Colour.Black,draw(e){tU.draw(e)},touch:e=>(e.colour=Colour.Silver,e),click(e){let t=e.parent;e.colour=Colour.Black,t.direction=lE(t.direction,!1),e.value=!0,t.updateValue(t);let l=t.parent;l.isSquare&&l.receiveNumber(l,t.value,t.channelId,{expanded:t.expanded,numberAtom:t})},offscreen:tU.offscreen,overlaps:tU.overlaps,value:!1,size:tD.size-1.5*tX,grab:e=>e.parent,x:lR.x+lR.width/2-(tD.size-1.5*tX)/2,y:lR.y+lR.height-(tD.size-1.5*tX)-tX/2},lD={hasBorder:!0,borderColour:Colour.Black,colour:Colour.Grey,draw(e){e.colour=e.value?Colour.Silver:Colour.Grey,tk.draw(e),e.drawX(e)},drawX(e){let{x:t,y:l}=tx(e),i=e.size,o=l+e.size/2-1*tR/2;eJ.fillStyle=e.borderColour,eJ.fillRect(t,o,i,1*tR)},offscreen:tk.offscreen,overlaps:tk.overlaps,expanded:!1,click(e){e.value=!e.value;let[t,l,i]=lw(e.parent.value);t=e.value?100:0,e.parent.value=t+l+i;let o=e.parent;if(o.parent!==ts){let a=o.parent;lg(a)}},value:!1,size:tD.size-tX,grab:e=>e.parent,x:lT.x+lT.width/2-(tD.size-tX)/2,y:lT.y+tX/2},lP={hasBorder:!0,borderColour:Colour.Black,colour:Colour.Grey,draw(e){e.colour=e.value?Colour.Silver:Colour.Grey,tk.draw(e),e.drawY(e)},drawY(e,t=e.size,l=0){let{x:i,y:o}=tx(e),a=i+e.size/2-1*tR/2;eJ.fillStyle=e.borderColour,eJ.fillRect(a,o+l,1*tR,t)},offscreen:tk.offscreen,overlaps:tk.overlaps,expanded:!1,click(e){e.value=!e.value;let[t,l,i]=lw(e.parent.value);l=e.value?10:0,e.parent.value=t+l+i;let o=e.parent;if(o.parent!==ts){let a=o.parent;lg(a)}},value:!1,size:tD.size-tX,grab:e=>e.parent,x:lT.x+lT.width/2-(tD.size-tX)/2,y:tX/2},lA={hasBorder:!0,borderColour:Colour.Black,colour:Colour.Grey,draw(e){e.colour=e.value?Colour.Silver:Colour.Grey,tk.draw(e),e.drawR(e)},drawR(e){let{x:t,y:l}=tx(e),i=t+e.size/2,o=l+e.size/2,a=e.size/2-3*tR;eJ.fillStyle=e.borderColour,eJ.beginPath(),eJ.arc(i,o,a,0,2*Math.PI),eJ.fill(),a-=tR,eJ.fillStyle=e.colour,eJ.beginPath(),eJ.arc(i,o,a,0,2*Math.PI),eJ.fill()},offscreen:tk.offscreen,overlaps:tk.overlaps,expanded:!1,click(e){e.value=!e.value;let[t,l,i]=lw(e.parent.value);i=e.value?1:0,e.parent.value=t+l+i;let o=e.parent;if(o.parent!==ts){let a=o.parent;lg(a)}},value:!1,size:tD.size-tX,grab:e=>e.parent,x:lT.x+lT.width/2-(tD.size-tX)/2,y:lT.y+lT.height-(tD.size-tX)-tX/2},lI=e=>{let t=tc({...tD});if(t.value=Q(e),void 0!==t.value){if(void 0!==t.value.joins)for(let l of t.value.joins){let i=lI(l);t.joins.push(i)}t.stamp=t.value.stamp}if(!t.value.isDiagram)for(let o=0;o<3;o++){let a=t.value.channels[o];if(void 0===a||void 0===a.variable)continue;let r=tc(tY);t.variableAtoms[o]=r,r.highlightedSlot=tj[o],r.channelId=o;let n=o-1<0?tj[2]:tj[o-1],d=o+1>2?tj[0]:tj[o+1];a.subtract?r.direction="down":a.add?r.direction="up":a.variable===n?r.direction="left":a.variable===d&&(r.direction="right"),r.updateValue(r)}return void 0!==t.value&&t.value.isDiagram&&t.update(t),t},lB=10,lL={element:tD,draw(e){(e.previousBrushColour!==state.brush.colour||e.toolbarNeedsColourUpdate)&&e.update(e),e.unlocked&&e.element.draw(e)},overlaps:(e,t,l)=>e.element.overlaps(e,t,l),grab:(e,t,l)=>e,drag(e){if(e===squareTool){let t=lI(e.value);return tp(t),t}let l=tc({...e.element,x:e.x,y:e.y});return tp(l),l.value,l},cursor:()=>"move"},lG=0,lN=(e,t)=>{let{width:l=tD.size,height:i=tD.size,size:o}=e,a=tH;i<tD.size&&(a+=(tD.size-i)/2),a+=tR;let r=tc({...lL,width:l,height:i,size:o,x:Math.round(lB),y:a,element:e});return r.menuId=lG,lG++,r.attached=!0,r.isTool=!0,r.previousBrushColour=void 0,r.colourId=0,r.dcolourId=1,r.colourTicker=1/0,r.hasBorder=!0,lB+=l,lB+=tX,tp(r),void 0===t?r.unlocked=!0:(r.unlocked=!1,r.grabbable=!1,unlocks[t]=r,UNLOCK_MODE&&lU(t)),r};unlocks={};let lU=e=>{let t=unlocks[e];t.unlocked||(t.unlocked=!0,t.grabbable=!0)};squareTool=lN(tD),lB+=tR;let l7=lN(tY,"triangle");lB-=tR;let lY=lN(lb,"circle"),lX=lN(t2,"hexagon"),l3={};lm(),squareTool.value=makeArrayFromSplash(state.brush.colour),lY.borderScale=1,squareTool.update=e=>{if(void 0===e.joinDrawId&&(e.joinDrawId=-1,e.joinDrawTimer=0),void 0!==e.value&&e===squareTool&&(e.previousBrushColour!==state.brush.colour||e.toolbarNeedsColourUpdate)){for(let t of(e.previousBrushColour=state.brush.colour,void 0===e.multiAtoms&&(e.multiAtoms=[]),e.multiAtoms))tb(e,t);if(e.multiAtoms=[],e.value.isDiagram){let l=e.value,[i,o]=eo(l),a=e.width/i,r=e.height/o;for(let n of l.left){let d=tw(e,tD);d.x=n.x*a,d.y=n.y*r,d.width=n.width*a,d.height=n.height*r,d.value=n.content,d.update(d),e.multiAtoms.push(d)}}}let h=Q(e.value);if(e.colours=M(h),e.colourId>=e.colours.length&&(e.colourId=0),e.toolbarNeedsColourUpdate&&e===squareTool){for(let s of(e.toolbarNeedsColourUpdate=!1,e.isGradient=!0,e.joins=[],e.value.joins)){let c=lI(s);e.joins.push(c)}tD.updateGradient(e)}else e.colour=Colour.splash(999),e.borderColour=Colour.splash(999)},l7.update=squareTool.update,lY.update=squareTool.update,l3.update=squareTool.update,lX.update=squareTool.update,on.keydown(e=>{(e.ctrlKey||e.metaKey)&&"s"===e.key?(e.preventDefault(),lW()):(e.ctrlKey||e.metaKey)&&"o"===e.key?(e.preventDefault(),lq()):(e.ctrlKey||e.metaKey)&&"c"===e.key&&(e.preventDefault(),l2())},{passive:!1}),on.paste(async e=>{let t=e.clipboardData.getData("text");if(""!==t){lj(t);return}let l=e.clipboardData.items[0],i=l.getAsFile(),o=await i.text();lj(o)}),on.dragover(e=>{e.stopPropagation(),e.preventDefault()},{passive:!1}),on.drop(async e=>{e.stopPropagation(),e.preventDefault();let t=e.dataTransfer.items[0],l=t.getAsFile(),i=await l.text();lj(i)},{passive:!1});let l1={},lH={};l1.cellAtoms=(e,t)=>{let l=[];for(let i of t)l.push({isLeftSlot:i.isLeftSlot,value:i.value,x:i.x,y:i.y,slotted:i.slotted?i.slotted.value:void 0});return l};let l8=!1;lH.cellAtoms=(e,t)=>{let l=[];for(let i of t){l8||(i.isLeftSlot||tO(i.value),l8=!0);let o=i.isLeftSlot?tc(la):lI(i.value);if(o.isLeftSlot=i.isLeftSlot,tp(o),t0(e,o),o.attached=!0,o.x=i.x,o.y=i.y,o.highlightedSide="left",l.push(o),void 0!==i.slotted){let a=lI(i.slotted);tp(a),t0(e,a),a.attached=!0,a.cellAtom=o,a.highlightedSide="slot",a.slottee=!0,o.slotted=a}}return l},l1.symmetryCircle=(e,t)=>{if(void 0!==t)return t.value},lH.symmetryCircle=(e,t)=>{let l=tw(e,lb);return l.value=t,l},l1.chance=(e,t)=>{if(void 0!==t)return t.ons},lH.chance=(e,t)=>{let l=tw(e,t2);return l.ons=t,l};l1.expanded=(e,t)=>t,l1.x=(e,t)=>t,l1.y=(e,t)=>t,l1.width=(e,t)=>t,l1.height=(e,t)=>t,l1.hasSymmetry=(e,t)=>t,lH.expanded=(e,t)=>t,lH.x=(e,t)=>t,lH.y=(e,t)=>t,lH.width=(e,t)=>t,lH.height=(e,t)=>t,lH.hasSymmetry=(e,t)=>t,l1.pinhole=(e,t)=>t.locked,lH.pinhole=(e,t)=>(e.pinhole.locked=t,e.pinhole),l1.rightTriangle=(e,t)=>void 0!==t,lH.rightTriangle=(e,t)=>{if(!t)return;let l=tw(e,tY);return l};let lV=()=>{let e=[];for(let t of paddles){let l={};for(let i in t){let o=l1[i];if(void 0===o)continue;let a=o(t,t[i]);void 0!==a&&(l[i]=a)}e.push(l)}return JSON.stringify(e)},lj=e=>{if(middleClicked){middleClicked=!1;return}l8=!1,lU("triangle"),lU("circle"),lU("hexagon");try{for(;paddles.length>0;)lv(paddles[paddles.length-1]);for(let t of JSON.parse(e)){let l=lm();for(let i in t){let o=lH[i];if(void 0===o)continue;let a=o(l,t[i]);void 0!==a&&(l[i]=a)}ln(l),lg(l)}lf()}catch(r){console.error(r),alert("Error loading rules... Sorry! Please contact @todepond :)")}},lW=async()=>{let e=lV(paddles);if(window.showSaveFilePicker)try{let t=await showSaveFilePicker({excludeAcceptAllOption:!0,suggestedName:"spell",startIn:"downloads",types:[{description:"JSON",accept:{"application/json":[".json"]}}]}),l=await t.createWritable();await l.write(e),await l.close()}catch(i){console.error("Failed to save file:",i)}else{let o=new Blob([e],{type:"application/json"}),a=URL.createObjectURL(o),r=document.createElement("a");r.href=a,r.download="spell.json",r.click(),URL.revokeObjectURL(a)}},lq=()=>{let e=document.createElement("input");e.type="file",e.onchange=async t=>{let l=e.files[0],i=await l.text();lj(i),Keyboard.Control=!1},e.click(),Keyboard.Control=!1},l2=()=>{let e=lV(paddles);print(e),navigator.clipboard.writeText(e)}});
